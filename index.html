<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Celestial Lab: ì ì„±ìˆ  ì—ë„ˆì§€ ì—°êµ¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* =========================================
       Celestial Gold Design System
       ========================================= */
    :root {
      --bg-main: #0A0E1A;
      --bg-card: #111827;
      --bg-input: #1E2433;
      
      --gold-main: #D4AF37;
      --gold-bright: #F5D77E;
      --gold-pale: #F7E7CE;
      
      --text-main: #F8FAFC;
      --text-sub: #94A3B8;
      --text-muted: #64748B;
      
      --accent-purple: #7C3AED;
      --accent-blue: #3B82F6;
      
      --success: #10B981;
      --error: #EF4444;
    }
    
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      margin: 0;
      padding-bottom: env(safe-area-inset-bottom);
      -webkit-font-smoothing: antialiased;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
    ::-webkit-scrollbar { display: none; }

    /* ë ˆì´ì•„ì›ƒ */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* íƒ€ì´í¬ê·¸ë˜í”¼ */
    h1, h2, h3 { letter-spacing: -0.02em; }
    .font-serif-accent { font-family: "Times New Roman", serif; letter-spacing: 0.05em; }

    /* ì»´í¬ë„ŒíŠ¸: ì¹´ë“œ */
    .celestial-card {
      background: var(--bg-card);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    
    /* ì»´í¬ë„ŒíŠ¸: ì…ë ¥ì°½ */
    .celestial-input {
      background: var(--bg-input);
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 0 16px;
      font-size: 16px;
      height: 52px;
      width: 100%;
      color: var(--text-main);
      outline: none;
      transition: all 0.3s ease;
      appearance: none;
    }
    .celestial-input:focus {
      border-color: var(--gold-main);
      box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.3);
    }
    .celestial-input::placeholder {
      color: var(--text-muted);
    }

    /* ì»´í¬ë„ŒíŠ¸: ë²„íŠ¼ */
    .btn-base {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 56px; /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .btn-base:active { transform: scale(0.98); }

    .btn-gold {
      background: linear-gradient(135deg, var(--gold-main), var(--gold-bright));
      color: var(--bg-main);
      border: none;
      box-shadow: 0 4px 16px rgba(212, 175, 55, 0.2);
    }
    .btn-gold:hover {
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gold-main);
      color: var(--gold-main);
    }
    .btn-outline:hover {
      background: rgba(212, 175, 55, 0.05);
    }
    
    .btn-ghost {
      background: rgba(255,255,255,0.05);
      color: var(--text-sub);
    }

    /* ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-selected {
      background: rgba(212, 175, 55, 0.15);
      border: 1px solid var(--gold-main);
      color: var(--gold-main);
    }

    /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .progress-fixed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 50;
      background: rgba(10, 14, 26, 0.95);
      backdrop-filter: blur(8px);
      height: 4px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold-main), var(--gold-bright));
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .slide-in {
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .delay-100 { animation-delay: 0.1s; opacity: 0; animation-fill-mode: forwards; }
    .delay-200 { animation-delay: 0.2s; opacity: 0; animation-fill-mode: forwards; }
    .delay-300 { animation-delay: 0.3s; opacity: 0; animation-fill-mode: forwards; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner-gold {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid var(--gold-main);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    /* Select ì•„ì´ì½˜ ì»¤ìŠ¤í…€ */
    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23D4AF37' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1.2em;
    }
    option {
      background-color: var(--bg-card);
      color: var(--text-main);
      padding: 10px;
    }

    /* ëŒ€í™”í˜• í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .guide-text {
      color: var(--text-sub);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    
    .section-title {
      color: var(--gold-main);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      background: var(--gold-main);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--gold-main);
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

  <!-- ìƒë‹¨ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
  <div class="progress-fixed">
    <div id="progress-fill" class="progress-bar" style="width: 0%"></div>
  </div>

  <!-- ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ -->
  <div id="app" class="app-container px-6 py-12 justify-center">
    <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
  </div>

  <script>
    // ============================================
    // API í‚¤ ë‚´ì¥ (ì—¬ê¸°ì—_API_í‚¤_ë„£ê¸°)
    // ============================================
    const API_KEY = "ì—¬ê¸°ì—_API_í‚¤_ë„£ê¸°";

    // ============================================
    // ë°ì´í„° (ê¸°ì¡´ ë¡œì§ 100% ìœ ì§€)
    // ============================================
    const CHEONGAN = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
    const JIJI = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
    const CHEONGAN_HANJA = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const JIJI_HANJA = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const CHEONGAN_ELEMENT = ['ëª©', 'ëª©', 'í™”', 'í™”', 'í† ', 'í† ', 'ê¸ˆ', 'ê¸ˆ', 'ìˆ˜', 'ìˆ˜'];
    const JIJI_ELEMENT = ['ìˆ˜', 'í† ', 'ëª©', 'ëª©', 'í† ', 'í™”', 'í™”', 'í† ', 'ê¸ˆ', 'ê¸ˆ', 'í† ', 'ìˆ˜'];
    const CHEONGAN_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];
    const JIJI_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];
    
    const ILGAN_DESC = {
      'ê°‘': 'ê³§ê²Œ ë»—ì€ ë‚˜ë¬´ (ì„±ì¥, ë¦¬ë”ì‹­)',
      'ì„': 'ìœ ì—°í•œ ë©êµ´ (ì ì‘, ëˆê¸°)',
      'ë³‘': 'íƒ€ì˜¤ë¥´ëŠ” íƒœì–‘ (ì—´ì •, ê³µëª…ì •ëŒ€)',
      'ì •': 'ë”°ìŠ¤í•œ ì´›ë¶ˆ (ì„¬ì„¸, í—Œì‹ )',
      'ë¬´': 'ë„“ì€ ëŒ€ì§€ (í¬ìš©, ì‹ ë¢°)',
      'ê¸°': 'ë¹„ì˜¥í•œ ë…¼ë°­ (ì‹¤ì†, ìê¸°ê´€ë¦¬)',
      'ê²½': 'ë‹¨ë‹¨í•œ ì›ì„ (ê²°ë‹¨, ì˜ë¦¬)',
      'ì‹ ': 'ë¹›ë‚˜ëŠ” ë³´ì„ (ì˜ˆë¦¬, ê¹”ë”)',
      'ì„': 'íë¥´ëŠ” í° ë¬¼ (ì§€í˜œ, ìœ ì—°)',
      'ê³„': 'ë‚´ë¦¬ëŠ” ë‹¨ë¹„ (ì´ëª…, ê°ìˆ˜ì„±)'
    };

    const SIGNS = ['ì–‘ìë¦¬', 'í™©ì†Œìë¦¬', 'ìŒë‘¥ì´ìë¦¬', 'ê²Œìë¦¬', 'ì‚¬ììë¦¬', 'ì²˜ë…€ìë¦¬', 
                   'ì²œì¹­ìë¦¬', 'ì „ê°ˆìë¦¬', 'ì‚¬ìˆ˜ìë¦¬', 'ì—¼ì†Œìë¦¬', 'ë¬¼ë³‘ìë¦¬', 'ë¬¼ê³ ê¸°ìë¦¬'];
    const SIGNS_EMOJI = ['â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“'];
    const SIGNS_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];
    const SIGNS_ELEMENT = ['í™”', 'ì§€', 'í’', 'ìˆ˜', 'í™”', 'ì§€', 'í’', 'ìˆ˜', 'í™”', 'ì§€', 'í’', 'ìˆ˜'];

    const MBTI_LIST = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP', 
                       'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP', 'ëª¨ë¦„'];
    
    const TIME_PERIOD_HOUR = {
      'dawn': 4,
      'morning': 7,
      'forenoon': 10,
      'afternoon': 13,
      'evening': 16,
      'night': 20,
      'late-night': 23
    };

    // ============================================
    // ìƒíƒœ ê´€ë¦¬
    // ============================================
    let state = {
      step: 1,
      apiKey: API_KEY, // ë‚´ì¥ëœ API í‚¤ ì‚¬ìš©
      formData: {
        name: '', year: '', month: '', day: '', 
        timeKnownType: '', // 'exact', 'rough', 'unknown'
        hour: '', minute: '0',
        roughTime: '', // ëŒ€ëµ ì‹œê°„
        gender: 'female', 
        mbti: '', 
        pastMbtiType: '', // 'same', 'different', 'forgot', 'partial'
        pastMbti: '', // 'E' ë˜ëŠ” 'I' ë˜ëŠ” ì „ì²´ MBTI
        pastMbtiPartial: '' // 'E' ë˜ëŠ” 'I'
      },
      western: { sunSign: '', moonSign: '', ascSign: '' },
      saju: null,
      daeun: null,
      aiAnalysis: null,
      answers: {},
      loading: false,
      savedData: JSON.parse(localStorage.getItem('astrology_data') || '[]')
    };

    // ============================================
    // ë¡œì§ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ì ˆëŒ€ ìœ ì§€)
    // ============================================
    function calculateSaju(year, month, day, hour) {
      const trueHour = hour - 0.53;
      let y = year;
      if (month < 2 || (month === 2 && day < 4)) y -= 1; 
      
      let yearGan = (y - 4) % 10;
      let yearJi = (y - 4) % 12;
      if (yearGan < 0) yearGan += 10;
      if (yearJi < 0) yearJi += 12;

      let monthJi = (month + 1) % 12;
      if (month === 1 && day < 6) monthJi = 0;
      if (month === 2 && day < 4) monthJi = 1; 
      
      const monthGanBase = (yearGan % 5) * 2;
      let monthGan = (monthGanBase + month) % 10;

      const baseDate = new Date(1900, 0, 1);
      const targetDate = new Date(year, month - 1, day);
      const diff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
      const dayGan = (diff + 10) % 10;
      const dayJi = (diff + 10 + 2) % 12;

      let hourJi = Math.floor((trueHour + 1) / 2) % 12;
      if (hourJi < 0) hourJi += 12;
      const dayGanGroup = dayGan % 5;
      const startHourGan = [0, 2, 4, 6, 8][dayGanGroup];
      const hourGan = (startHourGan + hourJi) % 10;

      const allYinyang = [
        CHEONGAN_YINYANG[yearGan], JIJI_YINYANG[yearJi],
        CHEONGAN_YINYANG[monthGan], JIJI_YINYANG[monthJi],
        CHEONGAN_YINYANG[dayGan], JIJI_YINYANG[dayJi],
        CHEONGAN_YINYANG[hourGan], JIJI_YINYANG[hourJi]
      ];
      const yangCount = allYinyang.filter(x => x === 'ì–‘').length;

      return {
        yearGan, yearJi, monthGan, monthJi, dayGan, dayJi, hourGan, hourJi,
        yangCount, yinCount: 8 - yangCount,
        ilgan: CHEONGAN[dayGan],
        ilganElement: CHEONGAN_ELEMENT[dayGan],
        fullText: `${CHEONGAN[yearGan]}${JIJI[yearJi]} ${CHEONGAN[monthGan]}${JIJI[monthJi]} ${CHEONGAN[dayGan]}${JIJI[dayJi]} ${CHEONGAN[hourGan]}${JIJI[hourJi]}`
      };
    }

    function calculateDaeun(saju, gender, birthYear) {
      const yearYinyang = CHEONGAN_YINYANG[saju.yearGan];
      let direction;
      if (gender === 'male') {
        direction = yearYinyang === 'ì–‘' ? 1 : -1;
      } else {
        direction = yearYinyang === 'ìŒ' ? 1 : -1;
      }

      const currentAge = 2026 - birthYear;
      const daeunList = [];
      
      for (let i = 0; i < 8; i++) {
        const age = i * 10 + 3;
        const ganIdx = (saju.monthGan + (i * direction) + 100) % 10;
        const jiIdx = (saju.monthJi + (i * direction) + 120) % 12;
        
        const isCurrent = age <= currentAge && currentAge < age + 10;
        
        daeunList.push({
          age: `${age}~${age+9}`,
          gan: CHEONGAN[ganIdx],
          ji: JIJI[jiIdx],
          ganElement: CHEONGAN_ELEMENT[ganIdx],
          jiElement: JIJI_ELEMENT[jiIdx],
          ganYinyang: CHEONGAN_YINYANG[ganIdx],
          jiYinyang: JIJI_YINYANG[jiIdx],
          isCurrent
        });
      }

      const current = daeunList.find(d => d.isCurrent) || daeunList[0];
      return { list: daeunList, current, direction: direction === 1 ? 'ìˆœí–‰' : 'ì—­í–‰' };
    }

    function getSunSign(month, day) {
      const dates = [20, 19, 21, 20, 21, 21, 23, 23, 23, 23, 22, 22];
      const signs = [9, 10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8];
      return day < dates[month - 1] ? signs[month - 1] : (signs[month - 1] + 1) % 12;
    }

    async function callGemini(prompt) {
      if (!state.apiKey || state.apiKey === "ì—¬ê¸°ì—_API_í‚¤_ë„£ê¸°") {
        throw new Error("API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ì½”ë“œì—ì„œ API_KEY ìƒìˆ˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.");
      }
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${state.apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: { temperature: 0.7, maxOutputTokens: 4000 }
            })
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage = `HTTP ì˜¤ë¥˜ (${response.status})`;
          try {
             const errorJson = JSON.parse(errorText);
             if (errorJson.error && errorJson.error.message) {
                 errorMessage = errorJson.error.message;
             }
          } catch(e) {}
          throw new Error(errorMessage);
        }

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
            throw new Error("AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
        return data.candidates[0].content.parts[0].text;
      } catch (e) {
        console.error("Gemini API í˜¸ì¶œ ì‹¤íŒ¨:", e);
        throw e;
      }
    }

    // ============================================
    // ë Œë”ë§ (ë¦¬ë””ìì¸ ì ìš©)
    // ============================================
    function render() {
      const app = document.getElementById('app');
      updateProgress();
      
      let html = '';
      if (state.step === 1) html = renderStep1();
      else if (state.step === 2) html = renderStep2();
      else if (state.step === 3) html = renderStep3();
      else if (state.step === 4) html = renderStep4();
      else if (state.step === 5) html = renderStep5();
      else if (state.step === 6) html = renderStep6();

      app.innerHTML = html;
      attachEvents();
    }

    function updateProgress() {
      const progressMap = { 1: 15, 2: 30, 3: 50, 4: 70, 5: 90, 6: 100 };
      const percent = progressMap[state.step] || 0;
      document.getElementById('progress-fill').style.width = `${percent}%`;
    }

    // Step 1: ê¸°ë³¸ ì •ë³´ ì…ë ¥ (í•­ìƒ í‘œì‹œ)
    function renderStep1() {
      return `
        <div class="fade-in space-y-8">
          <div class="text-center pt-8">
            <div class="inline-block mb-3 text-4xl">ğŸ”®</div>
            <h1 class="text-2xl font-bold font-serif-accent text-[#F8FAFC]">CELESTIAL LAB</h1>
            <p class="text-[#D4AF37] text-sm tracking-widest mt-1 opacity-80">ASTROLOGY ENERGY RESEARCH</p>
          </div>
          
          <div class="celestial-card fade-in delay-100">
            <h2 class="section-title">ì—°êµ¬ ëŒ€ìƒ í”„ë¡œí•„</h2>
            <p class="guide-text">
              ê³ ìœ í•œ ì—ë„ˆì§€ë¥¼ ë¶„ì„í•˜ê¸° ìœ„í•´<br>
              ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </p>
            
            <div class="space-y-5">
              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">ì´ë¦„</label>
                <input type="text" id="name" value="${state.formData.name}" 
                  class="celestial-input" placeholder="ì„±í•¨">
              </div>

              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">ì„±ë³„</label>
                <div class="grid grid-cols-2 gap-3">
                  <button type="button" 
                    class="btn-base ${state.formData.gender === 'female' ? 'btn-selected' : 'btn-outline'} h-[52px]"
                    onclick="setGender('female')">ì—¬ì„± (Female)</button>
                  <button type="button" 
                    class="btn-base ${state.formData.gender === 'male' ? 'btn-selected' : 'btn-outline'} h-[52px]"
                    onclick="setGender('male')">ë‚¨ì„± (Male)</button>
                </div>
              </div>

              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">ìƒë…„ì›”ì¼ (ì–‘ë ¥)</label>
                <div class="grid grid-cols-3 gap-2">
                  <input type="number" id="year" value="${state.formData.year}" 
                    class="celestial-input text-center px-0" placeholder="YYYY">
                  <input type="number" id="month" value="${state.formData.month}" 
                    class="celestial-input text-center px-0" placeholder="MM">
                  <input type="number" id="day" value="${state.formData.day}" 
                    class="celestial-input text-center px-0" placeholder="DD">
                </div>
              </div>

              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">íƒœì–´ë‚œ ì‹œê°„</label>
                <div class="space-y-3">
                  <div class="grid grid-cols-3 gap-2">
                    <button type="button" 
                      class="btn-base ${state.formData.timeKnownType === 'exact' ? 'btn-selected' : 'btn-outline'} h-[48px] text-sm"
                      onclick="setTimeKnownType('exact')">ì •í™•íˆ ì•Œì•„ìš”</button>
                    <button type="button" 
                      class="btn-base ${state.formData.timeKnownType === 'rough' ? 'btn-selected' : 'btn-outline'} h-[48px] text-sm"
                      onclick="setTimeKnownType('rough')">ëŒ€ëµ ì•Œì•„ìš”</button>
                    <button type="button" 
                      class="btn-base ${state.formData.timeKnownType === 'unknown' ? 'btn-selected' : 'btn-outline'} h-[48px] text-sm"
                      onclick="setTimeKnownType('unknown')">ëª°ë¼ìš”</button>
                  </div>
                  
                  ${state.formData.timeKnownType === 'exact' ? `
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <input type="number" id="hour" value="${state.formData.hour}" 
                          class="celestial-input text-center" placeholder="ì‹œ (0-23)" min="0" max="23">
                      </div>
                      <div>
                        <input type="number" id="minute" value="${state.formData.minute}" 
                          class="celestial-input text-center" placeholder="ë¶„ (0-59)" min="0" max="59">
                      </div>
                    </div>
                  ` : ''}
                  
                  ${state.formData.timeKnownType === 'rough' ? `
                    <select id="roughTime" class="celestial-input text-sm">
                      <option value="">ëŒ€ëµ ì‹œê°„ ì„ íƒ</option>
                      <option value="dawn" ${state.formData.roughTime === 'dawn' ? 'selected' : ''}>ìƒˆë²½ (03:00~06:00)</option>
                      <option value="morning" ${state.formData.roughTime === 'morning' ? 'selected' : ''}>ì•„ì¹¨ (06:00~09:00)</option>
                      <option value="forenoon" ${state.formData.roughTime === 'forenoon' ? 'selected' : ''}>ì˜¤ì „ (09:00~12:00)</option>
                      <option value="afternoon" ${state.formData.roughTime === 'afternoon' ? 'selected' : ''}>ì˜¤í›„ (12:00~15:00)</option>
                      <option value="evening" ${state.formData.roughTime === 'evening' ? 'selected' : ''}>ì €ë… (15:00~18:00)</option>
                      <option value="night" ${state.formData.roughTime === 'night' ? 'selected' : ''}>ë°¤ (18:00~22:00)</option>
                      <option value="late-night" ${state.formData.roughTime === 'late-night' ? 'selected' : ''}>ì‹¬ì•¼ (22:00~03:00)</option>
                    </select>
                  ` : ''}
                  
                  ${state.formData.timeKnownType === 'unknown' ? `
                    <div class="text-xs text-[#64748B] text-center py-2">
                      ì‹œê°„ ì—†ì´ë„ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </div>
                  ` : ''}
                </div>
              </div>

              <div class="pt-4 border-t border-[#374151]">
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">ì°¸ê³ ìš© MBTI</label>
                
                <div class="mb-3">
                  <label class="block text-xs text-[#64748B] mb-2">í˜„ì¬ MBTI</label>
                  <select id="mbti" class="celestial-input text-sm">
                    <option value="">ì„ íƒ</option>
                    ${MBTI_LIST.map(m => `<option value="${m}" ${state.formData.mbti === m ? 'selected' : ''}>${m}</option>`).join('')}
                  </select>
                </div>
                
                <div>
                  <label class="block text-xs text-[#64748B] mb-2">ê³¼ê±° MBTI</label>
                  <select id="pastMbtiType" class="celestial-input text-sm mb-2">
                    <option value="">ì„ íƒ</option>
                    <option value="same" ${state.formData.pastMbtiType === 'same' ? 'selected' : ''}>ê°™ìŒ/ì—†ìŒ</option>
                    <option value="different" ${state.formData.pastMbtiType === 'different' ? 'selected' : ''}>ë‹¬ëìŒ</option>
                    <option value="forgot" ${state.formData.pastMbtiType === 'forgot' ? 'selected' : ''}>ê¸°ì–µ ì•ˆ ë‚¨</option>
                    <option value="partial" ${state.formData.pastMbtiType === 'partial' ? 'selected' : ''}>ë¶€ë¶„ë§Œ ê¸°ì–µ (E/Ië§Œ)</option>
                  </select>
                  
                  ${state.formData.pastMbtiType === 'different' ? `
                    <select id="pastMbti" class="celestial-input text-sm">
                      <option value="">ê³¼ê±° MBTI ì„ íƒ</option>
                      ${MBTI_LIST.map(m => `<option value="${m}" ${state.formData.pastMbti === m ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                  ` : ''}
                  
                  ${state.formData.pastMbtiType === 'partial' ? `
                    <div class="grid grid-cols-2 gap-2">
                      <button type="button" 
                        class="btn-base ${state.formData.pastMbtiPartial === 'E' ? 'btn-selected' : 'btn-outline'} h-[48px] text-sm"
                        onclick="setPastMbtiPartial('E')">E</button>
                      <button type="button" 
                        class="btn-base ${state.formData.pastMbtiPartial === 'I' ? 'btn-selected' : 'btn-outline'} h-[48px] text-sm"
                        onclick="setPastMbtiPartial('I')">I</button>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>

            <div class="mt-8">
              <button onclick="goStep2()" class="btn-base btn-gold">
                ë¶„ì„ ì‹œì‘í•˜ê¸° âœ§
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Step 2: ì°¨íŠ¸ ê²°ê³¼ + ì„œì–‘ ì ì„±ìˆ  ë³´ì •
    function renderStep2() {
      const saju = state.saju;
      const daeun = state.daeun;
      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));
      
      return `
        <div class="fade-in space-y-5 pb-20">
          <div class="celestial-card">
            <p class="text-[#F8FAFC] text-lg font-light leading-relaxed">
              <strong class="text-[#D4AF37]">${state.formData.name}</strong> ë‹˜ì˜ ê³ ìœ  ì—ë„ˆì§€ê°€<br>
              ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
          </div>

          <!-- ì‚¬ì£¼ ì°¨íŠ¸ -->
          <div class="celestial-card fade-in delay-100">
            <h3 class="section-title">ì‚¬ì£¼ ëª…ì‹ (Oriental Chart)</h3>
            
            <div class="grid grid-cols-4 gap-0 border border-[#374151] rounded-lg overflow-hidden mb-4 bg-[#0A0E1A]">
              <div class="p-2 text-center border-r border-[#374151]">
                <div class="text-xs text-[#64748B] mb-1">ì‹œ</div>
                <div class="font-serif-accent text-xl">${CHEONGAN_HANJA[state.saju.hourGan]}</div>
                <div class="font-serif-accent text-xl">${JIJI_HANJA[state.saju.hourJi]}</div>
              </div>
              <div class="p-2 text-center border-r border-[#374151]">
                <div class="text-xs text-[#64748B] mb-1">ì¼</div>
                <div class="font-serif-accent text-xl text-[#D4AF37]">${CHEONGAN_HANJA[state.saju.dayGan]}</div>
                <div class="font-serif-accent text-xl text-[#D4AF37]">${JIJI_HANJA[state.saju.dayJi]}</div>
              </div>
              <div class="p-2 text-center border-r border-[#374151]">
                <div class="text-xs text-[#64748B] mb-1">ì›”</div>
                <div class="font-serif-accent text-xl">${CHEONGAN_HANJA[state.saju.monthGan]}</div>
                <div class="font-serif-accent text-xl">${JIJI_HANJA[state.saju.monthJi]}</div>
              </div>
              <div class="p-2 text-center">
                <div class="text-xs text-[#64748B] mb-1">ë…„</div>
                <div class="font-serif-accent text-xl">${CHEONGAN_HANJA[state.saju.yearGan]}</div>
                <div class="font-serif-accent text-xl">${JIJI_HANJA[state.saju.yearJi]}</div>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="text-[#94A3B8]">í•µì‹¬ ì„±í–¥ (ì¼ê°„)</span>
              <span class="text-[#F8FAFC] font-bold">${saju.ilgan} (${saju.ilganElement})</span>
            </div>
            <p class="text-xs text-[#64748B] mt-1 text-right">${ILGAN_DESC[saju.ilgan]}</p>
          </div>

          <!-- ëŒ€ìš´ -->
          <div class="celestial-card fade-in delay-200">
            <h3 class="section-title">í˜„ì¬ ëŒ€ìš´ (Current Flow)</h3>
            <div class="flex items-center justify-between">
              <div>
                <span class="text-xs text-[#94A3B8] block">í˜„ì¬ ëŒ€ìš´ (${daeun.current.age}ì„¸~)</span>
                <span class="text-2xl font-serif-accent text-[#F8FAFC]">${daeun.current.gan}${daeun.current.ji}</span>
              </div>
              <div class="text-right">
                <span class="block text-sm text-[#D4AF37]">${daeun.current.ganElement} / ${daeun.current.jiElement}</span>
                <span class="text-xs text-[#64748B]">ì—ë„ˆì§€ê°€ ì§€ë°°í•˜ëŠ” ì‹œê¸°</span>
              </div>
            </div>
          </div>

          <!-- ë³„ìë¦¬ -->
          <div class="celestial-card fade-in delay-300">
            <h3 class="section-title">ì²œì²´ ë°°ì¹˜ (Celestial Alignment)</h3>
            
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-[#1E2433] rounded-lg">
                <span class="text-sm text-[#94A3B8]">â˜€ï¸ íƒœì–‘ ë³„ìë¦¬ (Sun)</span>
                <span class="text-[#F8FAFC] font-bold">${SIGNS_EMOJI[sunIdx]} ${SIGNS[sunIdx]}</span>
              </div>

              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">ğŸŒ™ ë‹¬ ë³„ìë¦¬ (Moon) - ë‚´ë©´</label>
                <select id="moonSign" class="celestial-input text-sm h-[48px]">
                  <option value="">ëª¨ë¦„ / ì„ íƒ ì•ˆí•¨</option>
                  ${SIGNS.map((s, i) => `<option value="${i}" ${state.western.moonSign == i ? 'selected' : ''}>${SIGNS_EMOJI[i]} ${s}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block text-xs text-[#94A3B8] mb-1 ml-1">â¬†ï¸ ìƒìŠ¹ê¶ (Ascendant) - ì‚¬íšŒì  ê°€ë©´</label>
                <select id="ascSign" class="celestial-input text-sm h-[48px]">
                  <option value="">ëª¨ë¦„ / ì„ íƒ ì•ˆí•¨</option>
                  ${SIGNS.map((s, i) => `<option value="${i}" ${state.western.ascSign == i ? 'selected' : ''}>${SIGNS_EMOJI[i]} ${s}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="mt-3 text-right">
                <a href="https://astro.com" target="_blank" class="text-xs text-[#D4AF37] opacity-60 hover:opacity-100 underline">ë‚´ ì„œì–‘ ì ì„±ìˆ  ì°¨íŠ¸ í™•ì¸í•˜ê¸° â†—</a>
            </div>
          </div>

          <div class="flex gap-3 pt-4">
            <button onclick="state.step=1;render()" class="btn-base btn-outline w-[30%]">ì´ì „</button>
            <button onclick="goStep3()" class="btn-base btn-gold flex-1">
              ${state.loading ? 'ë¶„ì„ ì¤‘...' : 'ì‹¬ì¸µ ë¶„ì„ ìš”ì²­ âœ§'}
            </button>
          </div>
        </div>
      `;
    }

    // Step 3: ë¡œë”©
    function renderStep3() {
      if (state.loading) {
        return `
          <div class="flex flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="spinner-gold mb-8"></div>
            <h2 class="text-xl font-bold text-[#F8FAFC] mb-3 tracking-wide">ANALYZING</h2>
            <p class="text-[#94A3B8] text-center text-sm leading-relaxed">
              ë™ì–‘ì˜ ì‚¬ì£¼ì™€ ì„œì–‘ì˜ ë³„ìë¦¬ë¥¼<br>
              ì—°ê²°í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </p>
          </div>
        `;
      }
      
      if (!state.aiAnalysis) return '<div class="text-center p-10 text-[#EF4444]">ë°ì´í„° ì˜¤ë¥˜<br><button onclick="state.step=2;render()" class="underline mt-4">ëŒì•„ê°€ê¸°</button></div>';
      
      return `
        <div class="fade-in space-y-6 pb-20">
          <div class="text-center mb-4 pt-4">
            <div class="inline-block px-4 py-1 rounded-full border border-[#D4AF37] text-[#D4AF37] text-xs font-bold tracking-wider mb-4">
              ANALYSIS COMPLETE
            </div>
            <h2 class="text-2xl font-bold text-[#F8FAFC]">ì—ë„ˆì§€ ë¶„ì„ ì™„ë£Œ</h2>
          </div>

          <div class="celestial-card">
            <h3 class="section-title">í•µì‹¬ ìš”ì•½ (Summary)</h3>
            <p class="leading-relaxed text-[#E9D5FF] whitespace-pre-line text-sm">${state.aiAnalysis.summary || ''}</p>
          </div>

          <div class="celestial-card" style="border-left: 4px solid var(--accent-purple);">
            <h3 class="section-title" style="color: var(--accent-purple);">ì—ë„ˆì§€ ì„±í–¥ ì˜ˆì¸¡</h3>
            <div class="flex items-start gap-4">
              <span class="text-5xl font-serif-accent text-[#F8FAFC] leading-none">${state.aiAnalysis.eiPrediction || '?'}</span>
              <p class="text-sm text-[#94A3B8] leading-relaxed pt-1">${state.aiAnalysis.eiReason || ''}</p>
            </div>
          </div>

          <div class="celestial-card bg-[#1E2433] border-none">
            <p class="text-sm text-[#F8FAFC] text-center">
              "ë„ì¶œëœ ê²°ê³¼ì˜ ì •í™•ë„ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•´<br>
              ëª‡ ê°€ì§€ í™•ì¸ ì ˆì°¨ë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤."
            </p>
          </div>

          <button onclick="state.step=4;render()" class="btn-base btn-gold mt-4">
            ê²€ì¦ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      `;
    }

    // Step 4: ê¸°ë³¸ ê²€ì¦
    function renderStep4() {
      const questions = state.aiAnalysis?.basicQuestions || [];
      const answeredCount = Object.keys(state.answers).filter(k => k.startsWith('basic_')).length;
      
      if (answeredCount >= questions.length) {
         return `
           <div class="flex flex-col items-center justify-center min-h-[50vh] fade-in text-center p-6">
             <div class="text-5xl mb-6 text-[#10B981]">âœ“</div>
             <h2 class="text-2xl font-bold mb-3 text-[#F8FAFC]">1ì°¨ ê²€ì¦ ì™„ë£Œ</h2>
             <p class="text-[#94A3B8] mb-10 text-sm">
               ì´ì œ ì—ë„ˆì§€ê°€ ì¶©ëŒí•˜ê±°ë‚˜<br>ê·¹ëŒ€í™”ë˜ëŠ” ìƒí™©ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
             </p>
             <button onclick="state.step=5;render()" class="btn-base btn-gold">
               ì‹¬ì¸µ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
             </button>
           </div>
         `;
      }

      const currentQ = questions[answeredCount];
      const qIndex = answeredCount;

      return `
        <div class="fade-in min-h-[60vh] flex flex-col justify-center">
          <div class="text-center mb-8">
            <span class="text-xs text-[#D4AF37] font-bold tracking-widest">QUESTION ${qIndex + 1} / ${questions.length}</span>
          </div>
          
          <div class="celestial-card slide-in">
            <h3 class="text-lg font-bold leading-relaxed mb-4 text-[#F8FAFC] text-center">
              "${currentQ.question}"
            </h3>
            <p class="text-xs text-[#64748B] text-center border-t border-[#374151] pt-3 mt-3">
              ë¶„ì„ ê·¼ê±°: ${currentQ.reason}
            </p>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mt-4">
            <button onclick="setAnswer('basic_${qIndex}', 'YES')" 
              class="btn-base" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981;">
              ê·¸ë ‡ë‹¤ (YES)
            </button>
            <button onclick="setAnswer('basic_${qIndex}', 'NO')" 
              class="btn-base" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; color: #EF4444;">
              ì•„ë‹ˆë‹¤ (NO)
            </button>
          </div>
          
          <div class="text-center mt-8">
            <button onclick="state.step=3;render()" class="text-xs text-[#64748B] underline">ë‹¤ì‹œ ë¶„ì„ ê²°ê³¼ë¡œ</button>
          </div>
        </div>
      `;
    }

    // Step 5: ì¶©ëŒ í…ŒìŠ¤íŠ¸
    function renderStep5() {
      const tests = state.aiAnalysis?.conflictTests || [];
      const answeredCount = Object.keys(state.answers).filter(k => k.startsWith('conflict_')).length;

      if (answeredCount >= tests.length) {
        return `
           <div class="flex flex-col items-center justify-center min-h-[50vh] fade-in text-center p-6">
             <div class="spinner-gold mb-6 border-t-[#10B981] border-gray-700"></div>
             <h2 class="text-2xl font-bold mb-3 text-[#F8FAFC]">ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ</h2>
             <p class="text-[#94A3B8] mb-10 text-sm">
               ê·€í•˜ì˜ ì—ë„ˆì§€ ë°ì´í„°ë¥¼ ì—°êµ¬ì†Œ ë°ì´í„°ë² ì´ìŠ¤ì—<br>ê¸°ë¡í•©ë‹ˆë‹¤.
             </p>
             <button onclick="saveData()" class="btn-base btn-gold">
               ê²°ê³¼ ê¸°ë¡ ë° ì €ì¥
             </button>
           </div>
         `;
      }

      const currentT = tests[answeredCount];
      const tIndex = answeredCount;

      return `
        <div class="fade-in min-h-[60vh] flex flex-col justify-center">
           <div class="text-center mb-8">
            <span class="text-xs text-[#D4AF37] font-bold tracking-widest">SCENARIO ${tIndex + 1} / ${tests.length}</span>
          </div>

          <div class="celestial-card slide-in">
            <h3 class="text-lg font-bold mb-8 text-center text-[#F8FAFC] leading-relaxed">
              "${currentT.situation}"
            </h3>
            
            <div class="space-y-4">
              <button onclick="setAnswer('conflict_${tIndex}', 'A')" 
                class="btn-base flex-col items-start p-4 h-auto text-left" 
                style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6;">
                <span class="font-bold text-[#F8FAFC] mb-1 block">A. ${currentT.optionA}</span>
                <span class="text-xs text-[#3B82F6] opacity-80 block">${currentT.energyA}</span>
              </button>

              <button onclick="setAnswer('conflict_${tIndex}', 'B')" 
                class="btn-base flex-col items-start p-4 h-auto text-left"
                style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B;">
                <span class="font-bold text-[#F8FAFC] mb-1 block">B. ${currentT.optionB}</span>
                <span class="text-xs text-[#F59E0B] opacity-80 block">${currentT.energyB}</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Step 6: ì™„ë£Œ
    function renderStep6() {
      return `
        <div class="fade-in space-y-6 pb-20">
          <div class="text-center py-8">
             <div class="w-16 h-16 rounded-full bg-[#111827] border border-[#D4AF37] flex items-center justify-center mx-auto mb-6 shadow-[0_0_20px_rgba(212,175,55,0.3)]">
               <span class="text-2xl">ğŸ’¾</span>
             </div>
            <h2 class="text-2xl font-bold mb-2 text-[#F8FAFC]">ê¸°ë¡ ì™„ë£Œ</h2>
            <p class="text-[#94A3B8] text-sm">í˜„ì¬ê¹Œì§€ ì´ <span class="text-[#D4AF37] font-bold">${state.savedData.length}</span>ê±´ì˜<br>ì—°êµ¬ ë°ì´í„°ê°€ í™•ë³´ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <button onclick="resetForm()" class="btn-base btn-outline">
              ìƒˆë¡œìš´ ë¶„ì„
            </button>
            <button onclick="exportData()" class="btn-base btn-ghost" style="border: 1px solid #374151;">
              JSON ë‚´ë³´ë‚´ê¸°
            </button>
          </div>

          <div class="mt-10">
            <h3 class="section-title">ìµœê·¼ ì—°êµ¬ ê¸°ë¡ (Archives)</h3>
            <div class="space-y-3">
              ${state.savedData.slice().reverse().map(d => `
                <div class="celestial-card p-4 mb-0 flex justify-between items-center" style="padding: 16px;">
                  <div>
                    <div class="font-bold text-[#F8FAFC]">${d.name}</div>
                    <div class="text-xs text-[#64748B]">${d.birthDate}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-bold text-[#D4AF37]">${d.saju.ilgan}(${d.saju.ilganElement})</div>
                    <div class="text-xs text-[#64748B]">
                      ${d.eiPrediction} 
                      <span class="${d.eiPrediction === (d.mbti?.charAt(0) || '') ? 'text-[#10B981]' : 'text-[#EF4444]'}">
                        ${d.eiPrediction === (d.mbti?.charAt(0) || '') ? 'ì¼ì¹˜' : 'ë¶ˆì¼ì¹˜'}
                      </span>
                    </div>
                  </div>
                </div>
              `).join('')}
              ${state.savedData.length === 0 ? '<div class="text-center text-gray-500 py-4 text-xs">ë³´ê´€ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>' : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // ============================================
    function attachEvents() {
      ['name', 'year', 'month', 'day', 'hour', 'minute', 'mbti', 'pastMbti', 'roughTime'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onchange = (e) => state.formData[id] = e.target.value;
      });
      
      const pastMbtiTypeEl = document.getElementById('pastMbtiType');
      if (pastMbtiTypeEl) {
        pastMbtiTypeEl.onchange = (e) => {
          state.formData.pastMbtiType = e.target.value;
          if (e.target.value !== 'different') state.formData.pastMbti = '';
          if (e.target.value !== 'partial') state.formData.pastMbtiPartial = '';
          render();
        };
      }
      
      ['moonSign', 'ascSign'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onchange = (e) => state.western[id] = e.target.value;
      });
    }
    
    function setTimeKnownType(type) {
      state.formData.timeKnownType = type;
      if (type === 'unknown') {
        state.formData.hour = '';
        state.formData.minute = '0';
        state.formData.roughTime = '';
      } else if (type === 'exact') {
        state.formData.roughTime = '';
      } else if (type === 'rough') {
        state.formData.hour = '';
        state.formData.minute = '0';
      }
      render();
    }

    function setPastMbtiPartial(ei) {
      state.formData.pastMbtiPartial = ei;
      render();
    }

    function setGender(g) {
      state.formData.gender = g;
      render();
    }

    function goStep2() {
      if(document.getElementById('name')) state.formData.name = document.getElementById('name').value;
      if(document.getElementById('year')) state.formData.year = document.getElementById('year').value;
      if(document.getElementById('month')) state.formData.month = document.getElementById('month').value;
      if(document.getElementById('day')) state.formData.day = document.getElementById('day').value;
      if(document.getElementById('hour')) state.formData.hour = document.getElementById('hour').value;
      if(document.getElementById('minute')) state.formData.minute = document.getElementById('minute').value || '0';
      if(document.getElementById('roughTime')) state.formData.roughTime = document.getElementById('roughTime').value;
      
      // í•„ìˆ˜ ì •ë³´ ì²´í¬
      if (!state.formData.name || !state.formData.year || !state.formData.month || !state.formData.day) {
        alert('ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ì‹œê°„ ì²˜ë¦¬
      let hourForCalc = 12; // ê¸°ë³¸ê°’ (ì‹œê°„ ëª¨ë¥¼ ë•Œ)
      if (state.formData.timeKnownType === 'exact' && state.formData.hour !== '') {
        hourForCalc = parseInt(state.formData.hour);
      } else if (state.formData.timeKnownType === 'rough' && state.formData.roughTime) {
        hourForCalc = TIME_PERIOD_HOUR[state.formData.roughTime] || 12;
      } else if (state.formData.timeKnownType === 'unknown') {
        hourForCalc = 12; // ëª¨ë¥¼ ë•ŒëŠ” ì •ì˜¤ë¡œ ì„¤ì •
      }

      state.saju = calculateSaju(
        parseInt(state.formData.year),
        parseInt(state.formData.month),
        parseInt(state.formData.day),
        hourForCalc
      );

      state.daeun = calculateDaeun(state.saju, state.formData.gender, parseInt(state.formData.year));

      state.step = 2;
      render();
      window.scrollTo(0,0);
    }

    async function goStep3() {
      if (!state.apiKey || state.apiKey === "ì—¬ê¸°ì—_API_í‚¤_ë„£ê¸°") {
        alert('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œì—ì„œ API_KEY ìƒìˆ˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.');
        return;
      }

      state.loading = true;
      render();
      window.scrollTo(0,0);

      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));
      const moonIdx = state.western.moonSign ? parseInt(state.western.moonSign) : null;
      const ascIdx = state.western.ascSign ? parseInt(state.western.ascSign) : null;

      // ê³¼ê±° MBTI í…ìŠ¤íŠ¸ ìƒì„±
      let pastMbtiText = '';
      if (state.formData.pastMbtiType === 'same') {
        pastMbtiText = 'ê°™ìŒ/ì—†ìŒ';
      } else if (state.formData.pastMbtiType === 'different') {
        pastMbtiText = state.formData.pastMbti || 'ëª¨ë¦„';
      } else if (state.formData.pastMbtiType === 'forgot') {
        pastMbtiText = 'ê¸°ì–µ ì•ˆ ë‚¨';
      } else if (state.formData.pastMbtiType === 'partial') {
        pastMbtiText = `${state.formData.pastMbtiPartial || '?'} (ë¶€ë¶„ë§Œ ê¸°ì–µ)`;
      }

      const prompt = `ë‹¹ì‹ ì€ ë™ì–‘ ì‚¬ì£¼ì™€ ì„œì–‘ ì ì„±ìˆ  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ë¶„ì„ ëŒ€ìƒ:
- ì´ë¦„: ${state.formData.name}
- ìƒë…„ì›”ì¼: ${state.formData.year}.${state.formData.month}.${state.formData.day}
- ì„±ë³„: ${state.formData.gender === 'female' ? 'ì—¬ì' : 'ë‚¨ì'}
- í˜„ì¬ MBTI: ${state.formData.mbti || 'ëª¨ë¦„'}
${pastMbtiText ? `- ê³¼ê±° MBTI: ${pastMbtiText}` : ''}

ã€ë™ì–‘ ì‚¬ì£¼ã€‘
- ì‚¬ì£¼: ${state.saju.fullText}
- ì¼ê°„: ${state.saju.ilgan} (${state.saju.ilganElement}) - ${ILGAN_DESC[state.saju.ilgan]}
- ìŒì–‘: ì–‘ ${state.saju.yangCount}ê°œ / ìŒ ${state.saju.yinCount}ê°œ

ã€í˜„ì¬ ëŒ€ìš´ã€‘
- ${state.daeun.current.gan}${state.daeun.current.ji} (${state.daeun.current.ganElement}${state.daeun.current.jiElement})
- ${state.daeun.current.age}ì„¸

ã€ì„œì–‘ ì ì„±ìˆ ã€‘
- íƒœì–‘: ${SIGNS[sunIdx]} (${SIGNS_YINYANG[sunIdx]}/${SIGNS_ELEMENT[sunIdx]})
${moonIdx !== null ? `- ë‹¬: ${SIGNS[moonIdx]} (${SIGNS_YINYANG[moonIdx]}/${SIGNS_ELEMENT[moonIdx]})` : '- ë‹¬: ë¯¸ì…ë ¥'}
${ascIdx !== null ? `- ASC: ${SIGNS[ascIdx]} (${SIGNS_YINYANG[ascIdx]}/${SIGNS_ELEMENT[ascIdx]})` : '- ASC: ë¯¸ì…ë ¥'}
${sunIdx === ascIdx && ascIdx !== null ? '- âš ï¸ íƒœì–‘=ASC ê°™ìŒ!' : ''}

ì¤‘ìš”: ë‹¨ìˆœíˆ MBTI ì„±í–¥ì„ ë¬»ëŠ” ì§ˆë¬¸ì„ í•˜ì§€ ë§ˆì„¸ìš”.
ì˜¤ì§ ìœ„ì—ì„œ ì œê³µëœ **ì‚¬ì£¼(ì˜¤í–‰, ì¼ê°„, ëŒ€ìš´)**ì™€ **ë³„ìë¦¬(íƒœì–‘, ë‹¬, ASC)**ì˜ ê³ ìœ í•œ ì—ë„ˆì§€ íŠ¹ì„±ì— ì§‘ì¤‘í•˜ì„¸ìš”.

ë‹¤ìŒì„ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "summary": "ì´ ì‚¬ëŒì˜ ì‚¬ì£¼ì™€ ë³„ìë¦¬ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” í•µì‹¬ ì—ë„ˆì§€ ìš”ì•½ (3ì¤„ ì´ë‚´)",
  "eiPrediction": "E ë˜ëŠ” I",
  "eiReason": "ì°¨íŠ¸ ì—ë„ˆì§€(ì˜ˆ: í™”/ëª© ë°œë‹¬ ë“±)ì— ê¸°ë°˜í•œ ì˜ˆì¸¡ ê·¼ê±°",
  "basicQuestions": [
    {
       "question": "ì°¨íŠ¸ì˜ íŠ¹ì • ìš”ì†Œ(ì˜ˆ: ìˆ˜ê°€ ë§ìŒ)ì— ê¸°ë°˜í•œ ê²€ì¦ ì§ˆë¬¸", 
       "expected": "YES", 
       "reason": "ì‚¬ì£¼ì— ìˆ˜ ê¸°ìš´ì´ ë§ì•„ ìƒê°ì´ ë§ì„ ê²ƒìœ¼ë¡œ ì¶”ì •ë¨"
    },
    {
       "question": "ì°¨íŠ¸ì˜ íŠ¹ì • ìš”ì†Œ(ì˜ˆ: ë³„ìë¦¬ê°€ ë•…ì˜ ì†ì„±)ì— ê¸°ë°˜í•œ ê²€ì¦ ì§ˆë¬¸", 
       "expected": "YES", 
       "reason": "í™©ì†Œìë¦¬(í™)ì˜ ì˜í–¥ìœ¼ë¡œ ì•ˆì •ì„±ì„ ì¶”êµ¬í•  ê²ƒìœ¼ë¡œ ë³´ì„"
    },
    {
       "question": "ì§ˆë¬¸3", "expected": "YES", "reason": "ê·¼ê±°"
    },
    {
       "question": "ì§ˆë¬¸4", "expected": "YES", "reason": "ê·¼ê±°"
    },
    {
       "question": "ì§ˆë¬¸5", "expected": "NO", "reason": "ê·¼ê±°"
    }
  ],
  "conflictTests": [
    {"situation": "ì—ë„ˆì§€ê°€ ìƒì¶©í•˜ê±°ë‚˜ ê·¹ëŒ€í™”ë˜ëŠ” ìƒí™© ì„¤ì •1", "optionA": "ë°˜ì‘A", "energyA": "ê´€ë ¨ ì—ë„ˆì§€", "optionB": "ë°˜ì‘B", "energyB": "ê´€ë ¨ ì—ë„ˆì§€"},
    {"situation": "ìƒí™©2", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©3", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©4", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©5", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"}
  ]
}

ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì‘ë‹µí•˜ì„¸ìš”.`;

      try {
        const response = await callGemini(prompt);
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          state.aiAnalysis = JSON.parse(jsonMatch[0]);
        } else {
            throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨");
        }
        state.step = 3;
      } catch (e) {
        console.error(e);
        alert(`AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n${e.message}`);
        state.step = 2;
      }

      state.loading = false;
      render();
      window.scrollTo(0,0);
    }

    function setAnswer(key, value) {
      state.answers[key] = value;
      render();
    }

    function saveData() {
      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));
      
      // ê³¼ê±° MBTI ì €ì¥
      let savedPastMbti = '';
      if (state.formData.pastMbtiType === 'same') {
        savedPastMbti = 'same';
      } else if (state.formData.pastMbtiType === 'different') {
        savedPastMbti = state.formData.pastMbti || '';
      } else if (state.formData.pastMbtiType === 'forgot') {
        savedPastMbti = 'forgot';
      } else if (state.formData.pastMbtiType === 'partial') {
        savedPastMbti = state.formData.pastMbtiPartial || '';
      }
      
      const entry = {
        id: Date.now(),
        name: state.formData.name,
        birthDate: `${state.formData.year}.${state.formData.month}.${state.formData.day}`,
        birthTime: state.formData.hour || (state.formData.roughTime ? TIME_PERIOD_HOUR[state.formData.roughTime] : 12),
        gender: state.formData.gender,
        mbti: state.formData.mbti,
        pastMbti: savedPastMbti,
        saju: state.saju,
        daeun: state.daeun.current,
        western: {
          sun: SIGNS[sunIdx],
          moon: state.western.moonSign ? SIGNS[parseInt(state.western.moonSign)] : null,
          asc: state.western.ascSign ? SIGNS[parseInt(state.western.ascSign)] : null
        },
        eiPrediction: state.aiAnalysis?.eiPrediction,
        answers: state.answers,
        savedAt: new Date().toISOString()
      };

      state.savedData.push(entry);
      localStorage.setItem('astrology_data', JSON.stringify(state.savedData));
      
      state.step = 6;
      render();
      window.scrollTo(0,0);
    }

    function resetForm() {
      state.step = 1;
      state.formData = { 
        name: '', year: '', month: '', day: '', 
        timeKnownType: '', hour: '', minute: '0', roughTime: '',
        gender: 'female', 
        mbti: '', 
        pastMbtiType: '', pastMbti: '', pastMbtiPartial: ''
      };
      state.western = { sunSign: '', moonSign: '', ascSign: '' };
      state.saju = null;
      state.daeun = null;
      state.aiAnalysis = null;
      state.answers = {};
      render();
      window.scrollTo(0,0);
    }

    function exportData() {
      const dataStr = JSON.stringify(state.savedData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `astrology_research_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    // ì´ˆê¸° ì‹¤í–‰
    render();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>