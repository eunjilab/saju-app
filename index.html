<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ì‚¬ì£¼ë© - ë‚˜ë§Œì˜ ì—ë„ˆì§€ ë¶„ì„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* =========================================
       Tolan-Inspired Soft Design System
       ========================================= */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

    :root {
      --bg-cream: #FFFDF5;
      --bg-card: #FFFFFF;
      --bg-soft: #FFF8E7;

      --primary: #2D3047;
      --primary-light: #4A4E69;

      --accent-green: #7CB69D;
      --accent-pink: #F4A5AE;
      --accent-purple: #9B8DC4;
      --accent-blue: #7BA3C9;
      --accent-orange: #F4A261;

      --text-main: #2D3047;
      --text-sub: #6B7280;
      --text-muted: #9CA3AF;

      --success: #7CB69D;
      --error: #E57373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, var(--bg-cream) 0%, #FFF8E7 100%);
      color: var(--text-main);
      min-height: 100vh;
      margin: 0;
      padding-bottom: env(safe-area-inset-bottom);
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar { display: none; }

    .app-container {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* íƒ€ì´í¬ê·¸ë˜í”¼ */
    h1, h2, h3 {
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* ë¶€ë“œëŸ¬ìš´ ì¹´ë“œ */
    .soft-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(45, 48, 71, 0.08);
      margin-bottom: 16px;
    }

    /* ì…ë ¥ì°½ */
    .soft-input {
      background: #F9FAFB;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      padding: 0 18px;
      font-size: 16px;
      height: 56px;
      width: 100%;
      color: var(--text-main);
      outline: none;
      transition: all 0.2s ease;
    }
    .soft-input:focus {
      border-color: var(--accent-purple);
      background: #FFFFFF;
    }
    .soft-input::placeholder {
      color: var(--text-muted);
    }

    /* ë²„íŠ¼ */
    .btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      height: 56px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 16px;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(45, 48, 71, 0.2);
    }
    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(45, 48, 71, 0.2);
    }

    .btn-soft {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 52px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      background: #F3F4F6;
      color: var(--text-main);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-soft:active { transform: scale(0.98); }

    .btn-soft.selected {
      background: var(--accent-purple);
      color: white;
    }

    .btn-outline {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 52px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      background: transparent;
      color: var(--text-sub);
      border: 2px solid #E5E7EB;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* ì„ íƒ ì¹© */
    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: 100px;
      font-size: 14px;
      font-weight: 500;
      background: #F3F4F6;
      color: var(--text-sub);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chip.selected {
      background: var(--primary);
      color: white;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .float {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes pulse-soft {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    .pulse-soft {
      animation: pulse-soft 2s ease-in-out infinite;
    }

    /* ë¡œë”© */
    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid #E5E7EB;
      border-top: 4px solid var(--accent-purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 3D ìºë¦­í„° ì˜ì—­ */
    .character-area {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .planet {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7BA3C9 0%, #9B8DC4 50%, #F4A5AE 100%);
      box-shadow:
        inset -20px -20px 40px rgba(0,0,0,0.1),
        0 10px 30px rgba(123, 163, 201, 0.3);
      position: relative;
    }

    .planet::before {
      content: '';
      position: absolute;
      top: 15%;
      left: 20%;
      width: 30%;
      height: 20%;
      background: rgba(255,255,255,0.4);
      border-radius: 50%;
      filter: blur(5px);
    }

    .orbit {
      position: absolute;
      border: 2px solid rgba(155, 141, 196, 0.2);
      border-radius: 50%;
    }
    .orbit-1 { width: 180px; height: 180px; }
    .orbit-2 { width: 240px; height: 240px; }

    .mini-planet {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      position: absolute;
      animation: orbit 8s linear infinite;
    }

    @keyframes orbit {
      from { transform: rotate(0deg) translateX(90px) rotate(0deg); }
      to { transform: rotate(360deg) translateX(90px) rotate(-360deg); }
    }

    /* Select ìŠ¤íƒ€ì¼ */
    select.soft-input {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239B8DC4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 20px;
      padding-right: 48px;
    }

    /* í”„ë¡œê·¸ë ˆìŠ¤ */
    .progress-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #E5E7EB;
      transition: all 0.3s ease;
    }
    .progress-dot.active {
      width: 24px;
      border-radius: 4px;
      background: var(--accent-purple);
    }
    .progress-dot.completed {
      background: var(--accent-green);
    }

    /* ì‚¬ì£¼ ì°¨íŠ¸ í…Œì´ë¸” */
    .saju-table {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      background: #F9FAFB;
      padding: 16px;
      border-radius: 16px;
    }
    .saju-cell {
      text-align: center;
      padding: 12px 8px;
      background: white;
      border-radius: 12px;
    }
    .saju-cell.highlight {
      background: linear-gradient(135deg, #9B8DC4 0%, #7BA3C9 100%);
      color: white;
    }
    .saju-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .saju-char {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
    }

    /* ê²°ê³¼ ì¹´ë“œ */
    .result-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 600;
    }
    .result-badge.success {
      background: rgba(124, 182, 157, 0.15);
      color: var(--accent-green);
    }
    .result-badge.error {
      background: rgba(229, 115, 115, 0.15);
      color: var(--error);
    }
  </style>
</head>
<body>

  <!-- ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ -->
  <div id="app" class="app-container px-5 py-8">
    <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
  </div>

  <script>
    // API í‚¤ëŠ” Netlify í™˜ê²½ë³€ìˆ˜ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë¨

    // ============================================
    // ë°ì´í„°
    // ============================================
    const CHEONGAN = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
    const JIJI = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
    const CHEONGAN_HANJA = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const JIJI_HANJA = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const CHEONGAN_ELEMENT = ['ëª©', 'ëª©', 'í™”', 'í™”', 'í† ', 'í† ', 'ê¸ˆ', 'ê¸ˆ', 'ìˆ˜', 'ìˆ˜'];
    const JIJI_ELEMENT = ['ìˆ˜', 'í† ', 'ëª©', 'ëª©', 'í† ', 'í™”', 'í™”', 'í† ', 'ê¸ˆ', 'ê¸ˆ', 'í† ', 'ìˆ˜'];
    const CHEONGAN_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];
    const JIJI_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];

    const ILGAN_DESC = {
      'ê°‘': 'ê³§ê²Œ ë»—ì€ ë‚˜ë¬´ (ì„±ì¥, ë¦¬ë”ì‹­)',
      'ì„': 'ìœ ì—°í•œ ë©êµ´ (ì ì‘, ëˆê¸°)',
      'ë³‘': 'íƒ€ì˜¤ë¥´ëŠ” íƒœì–‘ (ì—´ì •, ê³µëª…ì •ëŒ€)',
      'ì •': 'ë”°ìŠ¤í•œ ì´›ë¶ˆ (ì„¬ì„¸, í—Œì‹ )',
      'ë¬´': 'ë„“ì€ ëŒ€ì§€ (í¬ìš©, ì‹ ë¢°)',
      'ê¸°': 'ë¹„ì˜¥í•œ ë…¼ë°­ (ì‹¤ì†, ìê¸°ê´€ë¦¬)',
      'ê²½': 'ë‹¨ë‹¨í•œ ì›ì„ (ê²°ë‹¨, ì˜ë¦¬)',
      'ì‹ ': 'ë¹›ë‚˜ëŠ” ë³´ì„ (ì˜ˆë¦¬, ê¹”ë”)',
      'ì„': 'íë¥´ëŠ” í° ë¬¼ (ì§€í˜œ, ìœ ì—°)',
      'ê³„': 'ë‚´ë¦¬ëŠ” ë‹¨ë¹„ (ì´ëª…, ê°ìˆ˜ì„±)'
    };

    const ILGAN_EMOJI = {
      'ê°‘': 'ğŸŒ²', 'ì„': 'ğŸŒ¿', 'ë³‘': 'â˜€ï¸', 'ì •': 'ğŸ•¯ï¸', 'ë¬´': 'ğŸ”ï¸',
      'ê¸°': 'ğŸŒ¾', 'ê²½': 'âš”ï¸', 'ì‹ ': 'ğŸ’', 'ì„': 'ğŸŒŠ', 'ê³„': 'ğŸ’§'
    };

    const SIGNS = ['ì–‘ìë¦¬', 'í™©ì†Œìë¦¬', 'ìŒë‘¥ì´ìë¦¬', 'ê²Œìë¦¬', 'ì‚¬ììë¦¬', 'ì²˜ë…€ìë¦¬',
                   'ì²œì¹­ìë¦¬', 'ì „ê°ˆìë¦¬', 'ì‚¬ìˆ˜ìë¦¬', 'ì—¼ì†Œìë¦¬', 'ë¬¼ë³‘ìë¦¬', 'ë¬¼ê³ ê¸°ìë¦¬'];
    const SIGNS_EMOJI = ['â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“'];
    const SIGNS_YINYANG = ['ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ', 'ì–‘', 'ìŒ'];
    const SIGNS_ELEMENT = ['í™”', 'ì§€', 'í’', 'ìˆ˜', 'í™”', 'ì§€', 'í’', 'ìˆ˜', 'í™”', 'ì§€', 'í’', 'ìˆ˜'];

    const MBTI_LIST = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP',
                       'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP', 'ëª¨ë¦„'];

    const TIME_PERIOD_HOUR = {
      'dawn': 4, 'morning': 7, 'forenoon': 10, 'afternoon': 13,
      'evening': 16, 'night': 20, 'late-night': 23
    };

    // ============================================
    // ìƒíƒœ ê´€ë¦¬
    // ============================================
    let state = {
      step: 1,
      formData: {
        name: '', year: '', month: '', day: '',
        timeKnownType: '', hour: '', minute: '0', roughTime: '',
        gender: 'female', mbti: '',
        pastMbtiType: '', pastMbti: '', pastMbtiPartial: ''
      },
      western: { sunSign: '', moonSign: '', ascSign: '' },
      saju: null,
      daeun: null,
      aiAnalysis: null,
      answers: {},
      loading: false,
      savedData: [],
      // ìƒí™©í…ŒìŠ¤íŠ¸ ì¶”ê°€ ìƒíƒœ
      conflictSubStep: null, // null, 'selectContext', 'answerByContext'
      conflictContext: null, // ì„ íƒí•œ ìƒí™© êµ¬ë¶„
      conflictContextAnswers: {} // ìƒí™©ë³„ ë‹µë³€
    };

    // ============================================
    // ë¡œì§ í•¨ìˆ˜
    // ============================================
    function calculateSaju(year, month, day, hour) {
      const trueHour = hour - 0.53;
      let y = year;
      if (month < 2 || (month === 2 && day < 4)) y -= 1;

      let yearGan = (y - 4) % 10;
      let yearJi = (y - 4) % 12;
      if (yearGan < 0) yearGan += 10;
      if (yearJi < 0) yearJi += 12;

      let monthJi = (month + 1) % 12;
      if (month === 1 && day < 6) monthJi = 0;
      if (month === 2 && day < 4) monthJi = 1;

      const monthGanBase = (yearGan % 5) * 2;
      let monthGan = (monthGanBase + month) % 10;

      const baseDate = new Date(1900, 0, 1);
      const targetDate = new Date(year, month - 1, day);
      const diff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
      const dayGan = (diff + 10) % 10;
      const dayJi = (diff + 10 + 2) % 12;

      let hourJi = Math.floor((trueHour + 1) / 2) % 12;
      if (hourJi < 0) hourJi += 12;
      const dayGanGroup = dayGan % 5;
      const startHourGan = [0, 2, 4, 6, 8][dayGanGroup];
      const hourGan = (startHourGan + hourJi) % 10;

      const allYinyang = [
        CHEONGAN_YINYANG[yearGan], JIJI_YINYANG[yearJi],
        CHEONGAN_YINYANG[monthGan], JIJI_YINYANG[monthJi],
        CHEONGAN_YINYANG[dayGan], JIJI_YINYANG[dayJi],
        CHEONGAN_YINYANG[hourGan], JIJI_YINYANG[hourJi]
      ];
      const yangCount = allYinyang.filter(x => x === 'ì–‘').length;

      return {
        yearGan, yearJi, monthGan, monthJi, dayGan, dayJi, hourGan, hourJi,
        yangCount, yinCount: 8 - yangCount,
        ilgan: CHEONGAN[dayGan],
        ilganElement: CHEONGAN_ELEMENT[dayGan],
        fullText: `${CHEONGAN[yearGan]}${JIJI[yearJi]} ${CHEONGAN[monthGan]}${JIJI[monthJi]} ${CHEONGAN[dayGan]}${JIJI[dayJi]} ${CHEONGAN[hourGan]}${JIJI[hourJi]}`
      };
    }

    function calculateDaeun(saju, gender, birthYear) {
      const yearYinyang = CHEONGAN_YINYANG[saju.yearGan];
      let direction;
      if (gender === 'male') {
        direction = yearYinyang === 'ì–‘' ? 1 : -1;
      } else {
        direction = yearYinyang === 'ìŒ' ? 1 : -1;
      }

      const currentAge = 2026 - birthYear;
      const daeunList = [];

      for (let i = 0; i < 8; i++) {
        const age = i * 10 + 3;
        const ganIdx = (saju.monthGan + (i * direction) + 100) % 10;
        const jiIdx = (saju.monthJi + (i * direction) + 120) % 12;
        const isCurrent = age <= currentAge && currentAge < age + 10;

        daeunList.push({
          age: `${age}~${age+9}`,
          gan: CHEONGAN[ganIdx],
          ji: JIJI[jiIdx],
          ganElement: CHEONGAN_ELEMENT[ganIdx],
          jiElement: JIJI_ELEMENT[jiIdx],
          ganYinyang: CHEONGAN_YINYANG[ganIdx],
          jiYinyang: JIJI_YINYANG[jiIdx],
          isCurrent
        });
      }

      const current = daeunList.find(d => d.isCurrent) || daeunList[0];
      return { list: daeunList, current, direction: direction === 1 ? 'ìˆœí–‰' : 'ì—­í–‰' };
    }

    function getSunSign(month, day) {
      const dates = [20, 19, 21, 20, 21, 21, 23, 23, 23, 23, 22, 22];
      const signs = [9, 10, 11, 0, 1, 2, 3, 4, 5, 6, 7, 8];
      return day < dates[month - 1] ? signs[month - 1] : (signs[month - 1] + 1) % 12;
    }

    async function callGemini(prompt) {
      try {
        // ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í†µí•´ API í˜¸ì¶œ (í‚¤ê°€ ì„œë²„ì— ìˆ¨ê²¨ì§)
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || `HTTP ì˜¤ë¥˜ (${response.status})`);
        }

        return data.text;
      } catch (e) {
        console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", e);
        throw e;
      }
    }

    // ============================================
    // ë Œë”ë§
    // ============================================
    function render() {
      const app = document.getElementById('app');

      let html = '';
      if (state.step === 1) html = renderStep1();
      else if (state.step === 2) html = renderStep2();
      else if (state.step === 3) html = renderStep3();
      else if (state.step === 4) html = renderStep4();
      else if (state.step === 5) html = renderStep5();
      else if (state.step === 6) html = renderStep6();

      app.innerHTML = html;
      attachEvents();
    }

    // Step 1: ì¸íŠ¸ë¡œ + ê¸°ë³¸ ì •ë³´
    function renderStep1() {
      return `
        <div class="fade-in flex flex-col min-h-[90vh]">
          <!-- ë¡œê³  ì˜ì—­ -->
          <div class="text-center pt-8 pb-6">
            <div class="character-area mb-4">
              <div class="orbit orbit-1"></div>
              <div class="orbit orbit-2"></div>
              <div class="planet float"></div>
              <div class="mini-planet" style="background: var(--accent-pink); top: 50%; left: 50%;"></div>
            </div>
            <h1 class="text-2xl font-bold text-[#2D3047] mb-2">ì‚¬ì£¼ë©</h1>
            <p class="text-sm text-[#6B7280]">ë‚˜ë§Œì˜ ì—ë„ˆì§€ë¥¼ ë¶„ì„í•´ë³´ì„¸ìš”</p>
          </div>

          <!-- ì…ë ¥ í¼ -->
          <div class="soft-card flex-1">
            <div class="space-y-5">
              <!-- ì´ë¦„ -->
              <div>
                <label class="block text-sm font-medium text-[#2D3047] mb-2">ì´ë¦„</label>
                <input type="text" id="name" value="${state.formData.name}"
                  class="soft-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
              </div>

              <!-- ì„±ë³„ -->
              <div>
                <label class="block text-sm font-medium text-[#2D3047] mb-2">ì„±ë³„</label>
                <div class="flex gap-3">
                  <button type="button"
                    class="chip flex-1 ${state.formData.gender === 'female' ? 'selected' : ''}"
                    onclick="setGender('female')">ì—¬ì„±</button>
                  <button type="button"
                    class="chip flex-1 ${state.formData.gender === 'male' ? 'selected' : ''}"
                    onclick="setGender('male')">ë‚¨ì„±</button>
                </div>
              </div>

              <!-- ìƒë…„ì›”ì¼ -->
              <div>
                <label class="block text-sm font-medium text-[#2D3047] mb-2">ìƒë…„ì›”ì¼ (ì–‘ë ¥)</label>
                <div class="grid grid-cols-3 gap-2">
                  <input type="number" id="year" value="${state.formData.year}"
                    class="soft-input text-center" placeholder="ë…„">
                  <input type="number" id="month" value="${state.formData.month}"
                    class="soft-input text-center" placeholder="ì›”">
                  <input type="number" id="day" value="${state.formData.day}"
                    class="soft-input text-center" placeholder="ì¼">
                </div>
              </div>

              <!-- íƒœì–´ë‚œ ì‹œê°„ -->
              <div>
                <label class="block text-sm font-medium text-[#2D3047] mb-2">íƒœì–´ë‚œ ì‹œê°„</label>
                <div class="flex gap-2 mb-3">
                  <button type="button"
                    class="chip flex-1 text-xs ${state.formData.timeKnownType === 'exact' ? 'selected' : ''}"
                    onclick="setTimeKnownType('exact')">ì •í™•íˆ ì•Œì•„ìš”</button>
                  <button type="button"
                    class="chip flex-1 text-xs ${state.formData.timeKnownType === 'rough' ? 'selected' : ''}"
                    onclick="setTimeKnownType('rough')">ëŒ€ëµ ì•Œì•„ìš”</button>
                  <button type="button"
                    class="chip flex-1 text-xs ${state.formData.timeKnownType === 'unknown' ? 'selected' : ''}"
                    onclick="setTimeKnownType('unknown')">ëª°ë¼ìš”</button>
                </div>

                ${state.formData.timeKnownType === 'exact' ? `
                  <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="hour" value="${state.formData.hour}"
                      class="soft-input text-center" placeholder="ì‹œ (0-23)">
                    <input type="number" id="minute" value="${state.formData.minute}"
                      class="soft-input text-center" placeholder="ë¶„">
                  </div>
                ` : ''}

                ${state.formData.timeKnownType === 'rough' ? `
                  <select id="roughTime" class="soft-input">
                    <option value="">ëŒ€ëµì ì¸ ì‹œê°„ëŒ€ ì„ íƒ</option>
                    <option value="dawn" ${state.formData.roughTime === 'dawn' ? 'selected' : ''}>ìƒˆë²½ (03:00~06:00)</option>
                    <option value="morning" ${state.formData.roughTime === 'morning' ? 'selected' : ''}>ì•„ì¹¨ (06:00~09:00)</option>
                    <option value="forenoon" ${state.formData.roughTime === 'forenoon' ? 'selected' : ''}>ì˜¤ì „ (09:00~12:00)</option>
                    <option value="afternoon" ${state.formData.roughTime === 'afternoon' ? 'selected' : ''}>ì˜¤í›„ (12:00~15:00)</option>
                    <option value="evening" ${state.formData.roughTime === 'evening' ? 'selected' : ''}>ì €ë… (15:00~18:00)</option>
                    <option value="night" ${state.formData.roughTime === 'night' ? 'selected' : ''}>ë°¤ (18:00~22:00)</option>
                    <option value="late-night" ${state.formData.roughTime === 'late-night' ? 'selected' : ''}>ì‹¬ì•¼ (22:00~03:00)</option>
                  </select>
                ` : ''}
              </div>

              <!-- MBTI -->
              <div>
                <label class="block text-sm font-medium text-[#2D3047] mb-2">MBTI (ì„ íƒ)</label>
                <select id="mbti" class="soft-input">
                  <option value="">ì„ íƒ ì•ˆí•¨</option>
                  ${MBTI_LIST.map(m => `<option value="${m}" ${state.formData.mbti === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <!-- ì‹œì‘ ë²„íŠ¼ -->
          <div class="pt-4 pb-8">
            <button onclick="goStep2()" class="btn-primary">
              ë¶„ì„ ì‹œì‘í•˜ê¸°
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    // Step 2: ì‚¬ì£¼ ê²°ê³¼
    function renderStep2() {
      const saju = state.saju;
      const daeun = state.daeun;
      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));

      return `
        <div class="fade-in space-y-4 pb-8">
          <!-- í”„ë¡œê·¸ë ˆìŠ¤ -->
          <div class="progress-dots mb-6">
            <div class="progress-dot completed"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
          </div>

          <!-- ì¸ì‚¬ -->
          <div class="text-center mb-4">
            <p class="text-lg">
              <span class="font-bold text-[#9B8DC4]">${state.formData.name}</span>ë‹˜ì˜
            </p>
            <p class="text-sm text-[#6B7280]">ì—ë„ˆì§€ ì°¨íŠ¸ê°€ ì™„ì„±ë˜ì—ˆì–´ìš”</p>
          </div>

          <!-- ì‚¬ì£¼ ì°¨íŠ¸ -->
          <div class="soft-card">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-xl">${ILGAN_EMOJI[saju.ilgan]}</span>
              <h3 class="font-bold text-[#2D3047]">ì‚¬ì£¼ ëª…ì‹</h3>
            </div>

            <div class="saju-table mb-4">
              <div class="saju-cell">
                <div class="saju-label">ì‹œì£¼</div>
                <div class="saju-char">${CHEONGAN_HANJA[saju.hourGan]}</div>
                <div class="saju-char" style="font-size: 18px; color: var(--text-sub);">${JIJI_HANJA[saju.hourJi]}</div>
              </div>
              <div class="saju-cell highlight">
                <div class="saju-label" style="color: rgba(255,255,255,0.7);">ì¼ì£¼</div>
                <div class="saju-char">${CHEONGAN_HANJA[saju.dayGan]}</div>
                <div class="saju-char" style="font-size: 18px; opacity: 0.8;">${JIJI_HANJA[saju.dayJi]}</div>
              </div>
              <div class="saju-cell">
                <div class="saju-label">ì›”ì£¼</div>
                <div class="saju-char">${CHEONGAN_HANJA[saju.monthGan]}</div>
                <div class="saju-char" style="font-size: 18px; color: var(--text-sub);">${JIJI_HANJA[saju.monthJi]}</div>
              </div>
              <div class="saju-cell">
                <div class="saju-label">ë…„ì£¼</div>
                <div class="saju-char">${CHEONGAN_HANJA[saju.yearGan]}</div>
                <div class="saju-char" style="font-size: 18px; color: var(--text-sub);">${JIJI_HANJA[saju.yearJi]}</div>
              </div>
            </div>

            <div class="bg-[#F9FAFB] rounded-xl p-4">
              <div class="flex justify-between items-center">
                <span class="text-sm text-[#6B7280]">ì¼ê°„ (í•µì‹¬ ì„±í–¥)</span>
                <span class="font-bold text-[#2D3047]">${saju.ilgan} Â· ${saju.ilganElement}</span>
              </div>
              <p class="text-xs text-[#9CA3AF] mt-1">${ILGAN_DESC[saju.ilgan]}</p>
            </div>
          </div>

          <!-- ëŒ€ìš´ -->
          <div class="soft-card">
            <h3 class="font-bold text-[#2D3047] mb-3">í˜„ì¬ ëŒ€ìš´</h3>
            <div class="flex items-center justify-between bg-gradient-to-r from-[#9B8DC4]/10 to-[#7BA3C9]/10 rounded-xl p-4">
              <div>
                <span class="text-2xl font-bold text-[#2D3047]">${daeun.current.gan}${daeun.current.ji}</span>
                <span class="text-sm text-[#6B7280] ml-2">${daeun.current.age}ì„¸</span>
              </div>
              <div class="text-right">
                <span class="text-sm font-medium text-[#9B8DC4]">${daeun.current.ganElement} Â· ${daeun.current.jiElement}</span>
              </div>
            </div>
          </div>

          <!-- ë³„ìë¦¬ -->
          <div class="soft-card">
            <h3 class="font-bold text-[#2D3047] mb-3">ë³„ìë¦¬</h3>

            <div class="space-y-3">
              <div class="flex items-center justify-between p-3 bg-[#F9FAFB] rounded-xl">
                <span class="text-sm text-[#6B7280]">â˜€ï¸ íƒœì–‘</span>
                <span class="font-medium">${SIGNS_EMOJI[sunIdx]} ${SIGNS[sunIdx]}</span>
              </div>

              <div>
                <label class="block text-xs text-[#9CA3AF] mb-1">ğŸŒ™ ë‹¬ ë³„ìë¦¬</label>
                <select id="moonSign" class="soft-input h-[48px]">
                  <option value="">ëª¨ë¦„</option>
                  ${SIGNS.map((s, i) => `<option value="${i}" ${state.western.moonSign == i ? 'selected' : ''}>${SIGNS_EMOJI[i]} ${s}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block text-xs text-[#9CA3AF] mb-1">â¬†ï¸ ìƒìŠ¹ê¶</label>
                <select id="ascSign" class="soft-input h-[48px]">
                  <option value="">ëª¨ë¦„</option>
                  ${SIGNS.map((s, i) => `<option value="${i}" ${state.western.ascSign == i ? 'selected' : ''}>${SIGNS_EMOJI[i]} ${s}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <!-- ë²„íŠ¼ -->
          <div class="flex gap-3 pt-4">
            <button onclick="state.step=1;render()" class="btn-outline flex-1">ì´ì „</button>
            <button onclick="goStep3()" class="btn-primary flex-[2]">
              ${state.loading ? 'ë¶„ì„ ì¤‘...' : 'AI ë¶„ì„ ìš”ì²­'}
            </button>
          </div>
        </div>
      `;
    }

    // Step 3: AI ë¶„ì„ ê²°ê³¼
    function renderStep3() {
      if (state.loading) {
        return `
          <div class="flex flex-col items-center justify-center min-h-[80vh] fade-in">
            <div class="character-area mb-8">
              <div class="planet pulse-soft"></div>
            </div>
            <div class="loader mb-6"></div>
            <h2 class="text-lg font-bold text-[#2D3047] mb-2">ë¶„ì„ ì¤‘ì´ì—ìš”</h2>
            <p class="text-sm text-[#6B7280] text-center">
              ì‚¬ì£¼ì™€ ë³„ìë¦¬ë¥¼ ì—°ê²°í•˜ê³  ìˆì–´ìš”
            </p>
          </div>
        `;
      }

      if (!state.aiAnalysis) {
        return `
          <div class="text-center p-10">
            <p class="text-[#E57373] mb-4">ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”</p>
            <button onclick="state.step=2;render()" class="btn-soft px-6">ëŒì•„ê°€ê¸°</button>
          </div>
        `;
      }

      return `
        <div class="fade-in space-y-4 pb-8">
          <!-- í”„ë¡œê·¸ë ˆìŠ¤ -->
          <div class="progress-dots mb-6">
            <div class="progress-dot completed"></div>
            <div class="progress-dot completed"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
          </div>

          <div class="text-center mb-6">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-[#7CB69D]/10 text-[#7CB69D] rounded-full text-sm font-medium mb-4">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
              </svg>
              ë¶„ì„ ì™„ë£Œ
            </div>
            <h2 class="text-xl font-bold text-[#2D3047]">ì—ë„ˆì§€ ë¶„ì„ ê²°ê³¼</h2>
          </div>

          <!-- ìš”ì•½ -->
          <div class="soft-card">
            <h3 class="font-bold text-[#2D3047] mb-3">í•µì‹¬ ìš”ì•½</h3>
            <p class="text-sm text-[#4A4E69] leading-relaxed whitespace-pre-line">${state.aiAnalysis.summary || ''}</p>
          </div>

          <!-- ì˜ˆì¸¡ -->
          <div class="soft-card" style="background: linear-gradient(135deg, rgba(155,141,196,0.1) 0%, rgba(123,163,201,0.1) 100%);">
            <h3 class="font-bold text-[#2D3047] mb-3">ì—ë„ˆì§€ ì„±í–¥ ì˜ˆì¸¡</h3>
            <div class="flex items-center gap-4">
              <span class="text-5xl font-bold text-[#9B8DC4]">${state.aiAnalysis.eiPrediction || '?'}</span>
              <p class="text-sm text-[#6B7280] leading-relaxed">${state.aiAnalysis.eiReason || ''}</p>
            </div>
          </div>

          <div class="soft-card bg-[#F9FAFB] text-center">
            <p class="text-sm text-[#4A4E69]">
              ê²°ê³¼ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•´<br>ëª‡ ê°€ì§€ ì§ˆë¬¸ì„ ë“œë¦´ê²Œìš”
            </p>
          </div>

          <button onclick="state.step=4;render()" class="btn-primary">
            ê²€ì¦ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      `;
    }

    // Step 4: ê²€ì¦ ì§ˆë¬¸
    function renderStep4() {
      const questions = state.aiAnalysis?.basicQuestions || [];
      const answeredCount = Object.keys(state.answers).filter(k => k.startsWith('basic_')).length;

      if (answeredCount >= questions.length) {
        return `
          <div class="flex flex-col items-center justify-center min-h-[70vh] fade-in text-center px-6">
            <div class="w-20 h-20 rounded-full bg-[#7CB69D]/10 flex items-center justify-center mb-6">
              <svg width="40" height="40" fill="none" stroke="#7CB69D" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h2 class="text-xl font-bold text-[#2D3047] mb-2">1ì°¨ ê²€ì¦ ì™„ë£Œ!</h2>
            <p class="text-sm text-[#6B7280] mb-8">
              ì´ì œ ìƒí™©ë³„ ë°˜ì‘ì„ í™•ì¸í• ê²Œìš”
            </p>
            <button onclick="state.step=5;render()" class="btn-primary w-full">
              ë‹¤ìŒ ë‹¨ê³„ë¡œ
            </button>
          </div>
        `;
      }

      const currentQ = questions[answeredCount];
      const qIndex = answeredCount;

      return `
        <div class="fade-in min-h-[80vh] flex flex-col">
          <!-- í”„ë¡œê·¸ë ˆìŠ¤ -->
          <div class="text-center py-6">
            <span class="text-xs font-medium text-[#9B8DC4]">ì§ˆë¬¸ ${qIndex + 1} / ${questions.length}</span>
            <div class="w-full bg-[#E5E7EB] rounded-full h-1 mt-2">
              <div class="bg-[#9B8DC4] h-1 rounded-full transition-all" style="width: ${((qIndex + 1) / questions.length) * 100}%"></div>
            </div>
          </div>

          <!-- ì§ˆë¬¸ -->
          <div class="flex-1 flex flex-col justify-center">
            <div class="soft-card text-center">
              <p class="text-lg font-medium text-[#2D3047] leading-relaxed mb-6">
                "${currentQ.question}"
              </p>
              <p class="text-xs text-[#9CA3AF] border-t border-[#E5E7EB] pt-4">
                ${currentQ.reason}
              </p>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
              <button onclick="setAnswer('basic_${qIndex}', 'YES')"
                class="btn-soft h-16 text-lg" style="background: rgba(124, 182, 157, 0.1); color: #7CB69D; border: 2px solid #7CB69D;">
                ê·¸ë ‡ë‹¤
              </button>
              <button onclick="setAnswer('basic_${qIndex}', 'NO')"
                class="btn-soft h-16 text-lg" style="background: rgba(229, 115, 115, 0.1); color: #E57373; border: 2px solid #E57373;">
                ì•„ë‹ˆë‹¤
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Step 5: ìƒí™© í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë²„ì „)
    function renderStep5() {
      const tests = state.aiAnalysis?.conflictTests || [];
      const answeredCount = Object.keys(state.answers).filter(k => k.startsWith('conflict_') && !k.includes('_context')).length;

      // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ
      if (answeredCount >= tests.length) {
        return `
          <div class="flex flex-col items-center justify-center min-h-[70vh] fade-in text-center px-6">
            <div class="character-area mb-6">
              <div class="planet"></div>
            </div>
            <h2 class="text-xl font-bold text-[#2D3047] mb-2">ëª¨ë“  ê²€ì¦ ì™„ë£Œ!</h2>
            <p class="text-sm text-[#6B7280] mb-8">
              ê²°ê³¼ë¥¼ ì €ì¥í• ê²Œìš”
            </p>
            <button onclick="saveData()" class="btn-primary w-full">
              ê²°ê³¼ ì €ì¥í•˜ê¸°
            </button>
          </div>
        `;
      }

      const currentT = tests[answeredCount];
      const tIndex = answeredCount;

      // "ìƒí™©ì— ë”°ë¼ ë‹¤ë¦„" ì„ íƒ í›„ - ìƒí™© êµ¬ë¶„ ì„ íƒ
      if (state.conflictSubStep === 'selectContext') {
        return `
          <div class="fade-in min-h-[80vh] flex flex-col">
            <div class="text-center py-6">
              <span class="text-xs font-medium text-[#9B8DC4]">ì¶”ê°€ ì§ˆë¬¸</span>
            </div>

            <div class="flex-1 flex flex-col justify-center">
              <div class="soft-card mb-4 text-center">
                <p class="text-sm text-[#6B7280] mb-2">ì•„ ê·¸ë ‡êµ¬ë‚˜!</p>
                <p class="text-lg font-medium text-[#2D3047]">
                  ì–´ë–¤ ìƒí™©ì—ì„œ ë‹¤ë¥´ê²Œ í–‰ë™í•´ìš”?
                </p>
              </div>

              <div class="space-y-3">
                <button onclick="selectContext('closeness')"
                  class="soft-card w-full text-left p-4 hover:border-[#9B8DC4] border-2 border-transparent transition-all cursor-pointer">
                  <span class="font-bold text-[#2D3047]">ğŸ‘¥ ì¹œí•œ ì‚¬ëŒ vs ì•ˆ ì¹œí•œ ì‚¬ëŒ</span>
                </button>
                <button onclick="selectContext('place')"
                  class="soft-card w-full text-left p-4 hover:border-[#9B8DC4] border-2 border-transparent transition-all cursor-pointer">
                  <span class="font-bold text-[#2D3047]">ğŸ¢ ì§ì¥/í•™êµ vs ê°œì¸ ìƒí™œ</span>
                </button>
                <button onclick="selectContext('mood')"
                  class="soft-card w-full text-left p-4 hover:border-[#9B8DC4] border-2 border-transparent transition-all cursor-pointer">
                  <span class="font-bold text-[#2D3047]">ğŸ˜Š ê¸°ë¶„ì— ë”°ë¼</span>
                </button>
                <button onclick="selectContext('person')"
                  class="soft-card w-full text-left p-4 hover:border-[#9B8DC4] border-2 border-transparent transition-all cursor-pointer">
                  <span class="font-bold text-[#2D3047]">ğŸ¤ ìƒëŒ€ë°©ì— ë”°ë¼</span>
                </button>
              </div>

              <button onclick="cancelContextSelect()" class="btn-outline mt-4">
                ë‹¤ì‹œ ì„ íƒí• ê²Œìš”
              </button>
            </div>
          </div>
        `;
      }

      // ìƒí™©ë³„ ë‹µë³€ ì„ íƒ
      if (state.conflictSubStep === 'answerByContext') {
        const contextLabels = {
          closeness: ['ì¹œí•œ ì‚¬ëŒí•œí…ŒëŠ”?', 'ì•ˆ ì¹œí•œ ì‚¬ëŒí•œí…ŒëŠ”?'],
          place: ['ì§ì¥/í•™êµì—ì„œëŠ”?', 'ê°œì¸ ìƒí™œì—ì„œëŠ”?'],
          mood: ['ê¸°ë¶„ ì¢‹ì„ ë•ŒëŠ”?', 'ê¸°ë¶„ ì•ˆ ì¢‹ì„ ë•ŒëŠ”?'],
          person: ['í¸í•œ ìƒëŒ€í•œí…ŒëŠ”?', 'ì–´ë ¤ìš´ ìƒëŒ€í•œí…ŒëŠ”?']
        };
        const labels = contextLabels[state.conflictContext] || ['ìƒí™©1', 'ìƒí™©2'];
        const answered1 = state.conflictContextAnswers[tIndex + '_1'];

        if (!answered1) {
          // ì²« ë²ˆì§¸ ìƒí™© ë‹µë³€
          return `
            <div class="fade-in min-h-[80vh] flex flex-col">
              <div class="text-center py-6">
                <span class="text-xs font-medium text-[#7CB69D]">${labels[0]}</span>
              </div>

              <div class="flex-1 flex flex-col justify-center">
                <div class="soft-card mb-4 text-center">
                  <p class="text-lg font-medium text-[#2D3047]">${labels[0]}</p>
                </div>

                <div class="space-y-3">
                  <button onclick="setContextAnswer('${tIndex}_1', 'A')"
                    class="soft-card w-full text-left p-4 hover:border-[#7BA3C9] border-2 border-transparent transition-all cursor-pointer">
                    <span class="font-bold text-[#2D3047]">A. ${currentT.optionA}</span>
                  </button>
                  <button onclick="setContextAnswer('${tIndex}_1', 'B')"
                    class="soft-card w-full text-left p-4 hover:border-[#F4A261] border-2 border-transparent transition-all cursor-pointer">
                    <span class="font-bold text-[#2D3047]">B. ${currentT.optionB}</span>
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          // ë‘ ë²ˆì§¸ ìƒí™© ë‹µë³€
          return `
            <div class="fade-in min-h-[80vh] flex flex-col">
              <div class="text-center py-6">
                <span class="text-xs font-medium text-[#F4A261]">${labels[1]}</span>
              </div>

              <div class="flex-1 flex flex-col justify-center">
                <div class="soft-card mb-4 text-center">
                  <p class="text-lg font-medium text-[#2D3047]">${labels[1]}</p>
                </div>

                <div class="space-y-3">
                  <button onclick="setContextAnswer('${tIndex}_2', 'A')"
                    class="soft-card w-full text-left p-4 hover:border-[#7BA3C9] border-2 border-transparent transition-all cursor-pointer">
                    <span class="font-bold text-[#2D3047]">A. ${currentT.optionA}</span>
                  </button>
                  <button onclick="setContextAnswer('${tIndex}_2', 'B')"
                    class="soft-card w-full text-left p-4 hover:border-[#F4A261] border-2 border-transparent transition-all cursor-pointer">
                    <span class="font-bold text-[#2D3047]">B. ${currentT.optionB}</span>
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      // ê¸°ë³¸ ìƒí™© í…ŒìŠ¤íŠ¸ í™”ë©´ (4ì§€ì„ ë‹¤)
      return `
        <div class="fade-in min-h-[80vh] flex flex-col">
          <!-- í”„ë¡œê·¸ë ˆìŠ¤ -->
          <div class="text-center py-6">
            <span class="text-xs font-medium text-[#F4A261]">ì‹œë‚˜ë¦¬ì˜¤ ${tIndex + 1} / ${tests.length}</span>
            <div class="w-full bg-[#E5E7EB] rounded-full h-1 mt-2">
              <div class="bg-[#F4A261] h-1 rounded-full transition-all" style="width: ${((tIndex + 1) / tests.length) * 100}%"></div>
            </div>
          </div>

          <div class="flex-1 flex flex-col justify-center">
            <div class="soft-card mb-4">
              <p class="text-sm text-[#9B8DC4] text-center mb-2">ì´ëŸ° ìƒí™©ì—ì„œ ë³´í†µ ì–´ë–»ê²Œ í•´ìš”?</p>
              <p class="text-lg font-medium text-[#2D3047] leading-relaxed text-center">
                "${currentT.situation}"
              </p>
            </div>

            <div class="space-y-3">
              <button onclick="setConflictAnswer('${tIndex}', 'A')"
                class="soft-card w-full text-left p-4 hover:border-[#7BA3C9] border-2 border-transparent transition-all cursor-pointer">
                <span class="font-bold text-[#2D3047] block mb-1">A. ${currentT.optionA}</span>
                <span class="text-xs text-[#7BA3C9]">${currentT.energyA}</span>
              </button>

              <button onclick="setConflictAnswer('${tIndex}', 'B')"
                class="soft-card w-full text-left p-4 hover:border-[#F4A261] border-2 border-transparent transition-all cursor-pointer">
                <span class="font-bold text-[#2D3047] block mb-1">B. ${currentT.optionB}</span>
                <span class="text-xs text-[#F4A261]">${currentT.energyB}</span>
              </button>

              <button onclick="setConflictAnswer('${tIndex}', 'BOTH')"
                class="soft-card w-full text-left p-4 hover:border-[#7CB69D] border-2 border-transparent transition-all cursor-pointer">
                <span class="font-bold text-[#2D3047]">ë‘˜ ë‹¤ í•´ë‹¹í•´ìš”</span>
                <span class="text-xs text-[#7CB69D]">ë‘ ê°€ì§€ ëª¨ë‘ ë‚˜ë‹µë‹¤ê³  ëŠê»´ìš”</span>
              </button>

              <button onclick="setConflictAnswer('${tIndex}', 'DEPENDS')"
                class="soft-card w-full text-left p-4 hover:border-[#9B8DC4] border-2 border-transparent transition-all cursor-pointer">
                <span class="font-bold text-[#2D3047]">ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ìš”</span>
                <span class="text-xs text-[#9B8DC4]">ëˆ„êµ¬ë‘ ìˆëŠ”ì§€, ì–´ë””ì¸ì§€ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í–‰ë™í•´ìš”</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ìƒí™©í…ŒìŠ¤íŠ¸ ë‹µë³€ ì²˜ë¦¬
    function setConflictAnswer(index, value) {
      if (value === 'DEPENDS') {
        state.conflictSubStep = 'selectContext';
        render();
      } else {
        state.answers['conflict_' + index] = value;
        state.conflictSubStep = null;
        state.conflictContext = null;
        render();
      }
    }

    function selectContext(context) {
      state.conflictContext = context;
      state.conflictSubStep = 'answerByContext';
      render();
    }

    function cancelContextSelect() {
      state.conflictSubStep = null;
      state.conflictContext = null;
      render();
    }

    function setContextAnswer(key, value) {
      state.conflictContextAnswers[key] = value;

      // ë‘ ë²ˆì§¸ ë‹µë³€ê¹Œì§€ ì™„ë£Œë˜ë©´ ë©”ì¸ ë‹µë³€ìœ¼ë¡œ ì €ì¥
      const index = key.split('_')[0];
      if (key.endsWith('_2')) {
        const answer1 = state.conflictContextAnswers[index + '_1'];
        state.answers['conflict_' + index] = 'DEPENDS';
        state.answers['conflict_' + index + '_context'] = state.conflictContext;
        state.answers['conflict_' + index + '_detail'] = { first: answer1, second: value };
        state.conflictSubStep = null;
        state.conflictContext = null;
      }
      render();
    }

    // Step 6: ì™„ë£Œ
    function renderStep6() {
      return `
        <div class="fade-in space-y-6 pb-8">
          <!-- ì™„ë£Œ í—¤ë” -->
          <div class="text-center py-8">
            <div class="character-area mb-4" style="height: 150px;">
              <div class="planet float" style="width: 80px; height: 80px;"></div>
            </div>
            <h2 class="text-2xl font-bold text-[#2D3047] mb-2">ì €ì¥ ì™„ë£Œ!</h2>
            <p class="text-sm text-[#6B7280]">
              ì´ <span class="font-bold text-[#9B8DC4]">${state.savedData.length}</span>ê±´ì˜ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆì–´ìš”
            </p>
          </div>

          <!-- ë²„íŠ¼ -->
          <div class="grid grid-cols-2 gap-3">
            <button onclick="resetForm()" class="btn-primary">
              ìƒˆë¡œìš´ ë¶„ì„
            </button>
            <button onclick="exportData()" class="btn-outline">
              ë‚´ë³´ë‚´ê¸°
            </button>
          </div>

          <!-- ê¸°ë¡ ëª©ë¡ -->
          <div class="soft-card">
            <h3 class="font-bold text-[#2D3047] mb-4">ìµœê·¼ ê¸°ë¡</h3>
            <div class="space-y-3">
              ${state.savedData.slice().reverse().slice(0, 5).map(d => `
                <div class="flex justify-between items-center p-3 bg-[#F9FAFB] rounded-xl">
                  <div>
                    <div class="font-medium text-[#2D3047]">${d.name}</div>
                    <div class="text-xs text-[#9CA3AF]">${d.birthDate}</div>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-[#9B8DC4]">${d.saju.ilgan}(${d.saju.ilganElement})</div>
                    <div class="result-badge ${d.eiPrediction === (d.mbti?.charAt(0) || '') ? 'success' : 'error'} text-xs mt-1">
                      ${d.eiPrediction === (d.mbti?.charAt(0) || '') ? 'ì¼ì¹˜' : 'ë¶ˆì¼ì¹˜'}
                    </div>
                  </div>
                </div>
              `).join('')}
              ${state.savedData.length === 0 ? '<p class="text-center text-[#9CA3AF] py-4 text-sm">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ì–´ìš”</p>' : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ============================================
    function attachEvents() {
      ['name', 'year', 'month', 'day', 'hour', 'minute', 'mbti', 'roughTime'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onchange = (e) => state.formData[id] = e.target.value;
      });

      ['moonSign', 'ascSign'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onchange = (e) => state.western[id] = e.target.value;
      });
    }

    function setTimeKnownType(type) {
      state.formData.timeKnownType = type;
      if (type === 'unknown') {
        state.formData.hour = '';
        state.formData.minute = '0';
        state.formData.roughTime = '';
      } else if (type === 'exact') {
        state.formData.roughTime = '';
      } else if (type === 'rough') {
        state.formData.hour = '';
        state.formData.minute = '0';
      }
      render();
    }

    function setGender(g) {
      state.formData.gender = g;
      render();
    }

    function goStep2() {
      if(document.getElementById('name')) state.formData.name = document.getElementById('name').value;
      if(document.getElementById('year')) state.formData.year = document.getElementById('year').value;
      if(document.getElementById('month')) state.formData.month = document.getElementById('month').value;
      if(document.getElementById('day')) state.formData.day = document.getElementById('day').value;
      if(document.getElementById('hour')) state.formData.hour = document.getElementById('hour').value;
      if(document.getElementById('minute')) state.formData.minute = document.getElementById('minute').value || '0';
      if(document.getElementById('roughTime')) state.formData.roughTime = document.getElementById('roughTime').value;

      if (!state.formData.name || !state.formData.year || !state.formData.month || !state.formData.day) {
        alert('ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      let hourForCalc = 12;
      if (state.formData.timeKnownType === 'exact' && state.formData.hour !== '') {
        hourForCalc = parseInt(state.formData.hour);
      } else if (state.formData.timeKnownType === 'rough' && state.formData.roughTime) {
        hourForCalc = TIME_PERIOD_HOUR[state.formData.roughTime] || 12;
      }

      state.saju = calculateSaju(
        parseInt(state.formData.year),
        parseInt(state.formData.month),
        parseInt(state.formData.day),
        hourForCalc
      );

      state.daeun = calculateDaeun(state.saju, state.formData.gender, parseInt(state.formData.year));

      state.step = 2;
      render();
      window.scrollTo(0,0);
    }

    async function goStep3() {

      state.loading = true;
      state.step = 3;
      render();
      window.scrollTo(0,0);

      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));
      const moonIdx = state.western.moonSign ? parseInt(state.western.moonSign) : null;
      const ascIdx = state.western.ascSign ? parseInt(state.western.ascSign) : null;

      const prompt = `ë‹¹ì‹ ì€ ë™ì–‘ ì‚¬ì£¼ì™€ ì„œì–‘ ì ì„±ìˆ  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ë¶„ì„ ëŒ€ìƒ:
- ì´ë¦„: ${state.formData.name}
- ìƒë…„ì›”ì¼: ${state.formData.year}.${state.formData.month}.${state.formData.day}
- ì„±ë³„: ${state.formData.gender === 'female' ? 'ì—¬ì' : 'ë‚¨ì'}
- í˜„ì¬ MBTI: ${state.formData.mbti || 'ëª¨ë¦„'}

ã€ë™ì–‘ ì‚¬ì£¼ã€‘
- ì‚¬ì£¼: ${state.saju.fullText}
- ì¼ê°„: ${state.saju.ilgan} (${state.saju.ilganElement}) - ${ILGAN_DESC[state.saju.ilgan]}
- ìŒì–‘: ì–‘ ${state.saju.yangCount}ê°œ / ìŒ ${state.saju.yinCount}ê°œ

ã€í˜„ì¬ ëŒ€ìš´ã€‘
- ${state.daeun.current.gan}${state.daeun.current.ji} (${state.daeun.current.ganElement}${state.daeun.current.jiElement})

ã€ì„œì–‘ ì ì„±ìˆ ã€‘
- íƒœì–‘: ${SIGNS[sunIdx]} (${SIGNS_YINYANG[sunIdx]}/${SIGNS_ELEMENT[sunIdx]})
${moonIdx !== null ? `- ë‹¬: ${SIGNS[moonIdx]}` : '- ë‹¬: ë¯¸ì…ë ¥'}
${ascIdx !== null ? `- ASC: ${SIGNS[ascIdx]}` : '- ASC: ë¯¸ì…ë ¥'}

ë‹¤ìŒì„ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "summary": "ì´ ì‚¬ëŒì˜ í•µì‹¬ ì—ë„ˆì§€ ìš”ì•½ (3ì¤„)",
  "eiPrediction": "E ë˜ëŠ” I",
  "eiReason": "ì˜ˆì¸¡ ê·¼ê±°",
  "basicQuestions": [
    {"question": "ê²€ì¦ ì§ˆë¬¸1", "expected": "YES", "reason": "ê·¼ê±°"},
    {"question": "ê²€ì¦ ì§ˆë¬¸2", "expected": "YES", "reason": "ê·¼ê±°"},
    {"question": "ê²€ì¦ ì§ˆë¬¸3", "expected": "YES", "reason": "ê·¼ê±°"},
    {"question": "ê²€ì¦ ì§ˆë¬¸4", "expected": "NO", "reason": "ê·¼ê±°"},
    {"question": "ê²€ì¦ ì§ˆë¬¸5", "expected": "NO", "reason": "ê·¼ê±°"}
  ],
  "conflictTests": [
    {"situation": "ìƒí™©1", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©2", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©3", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©4", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"},
    {"situation": "ìƒí™©5", "optionA": "ì„ íƒA", "energyA": "ì—ë„ˆì§€A", "optionB": "ì„ íƒB", "energyB": "ì—ë„ˆì§€B"}
  ]
}

ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì‘ë‹µí•˜ì„¸ìš”.`;

      try {
        const response = await callGemini(prompt);
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          state.aiAnalysis = JSON.parse(jsonMatch[0]);
        } else {
          throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ${e.message}`);
        state.step = 2;
      }

      state.loading = false;
      render();
      window.scrollTo(0,0);
    }

    function setAnswer(key, value) {
      state.answers[key] = value;
      render();
    }

    async function saveData() {
      const sunIdx = getSunSign(parseInt(state.formData.month), parseInt(state.formData.day));

      const entry = {
        name: state.formData.name,
        birthDate: `${state.formData.year}.${state.formData.month}.${state.formData.day}`,
        birthTime: state.formData.hour ? parseInt(state.formData.hour) : (state.formData.roughTime ? TIME_PERIOD_HOUR[state.formData.roughTime] : 12),
        gender: state.formData.gender,
        mbti: state.formData.mbti,
        saju: state.saju,
        daeun: state.daeun.current,
        western: {
          sun: SIGNS[sunIdx],
          moon: state.western.moonSign ? SIGNS[parseInt(state.western.moonSign)] : null,
          asc: state.western.ascSign ? SIGNS[parseInt(state.western.ascSign)] : null
        },
        eiPrediction: state.aiAnalysis?.eiPrediction,
        answers: state.answers
      };

      try {
        // Supabaseì™€ Notionì— ë™ì‹œ ì €ì¥
        const [supabaseResult, notionResult] = await Promise.allSettled([
          // Supabase ì €ì¥
          fetch('/api/supabase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          }).then(r => r.json()),

          // Notion ì €ì¥ (ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ)
          fetch('/api/notion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          }).then(r => r.json()).catch(() => null)
        ]);

        // Supabase ê²°ê³¼ í™•ì¸
        if (supabaseResult.status === 'rejected') {
          throw new Error('Supabase ì €ì¥ ì‹¤íŒ¨');
        }

        // ì €ì¥ ì„±ê³µ í›„ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        await loadSavedData();

        // ë…¸ì…˜ ì €ì¥ ê²°ê³¼ ì•Œë¦¼ (ì„ íƒì )
        const notionOk = notionResult.status === 'fulfilled' && notionResult.value?.success;
        state.notionSaved = notionOk;

        state.step = 6;
        render();
        window.scrollTo(0,0);
      } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    async function loadSavedData() {
      try {
        const response = await fetch('/api/supabase');
        const result = await response.json();

        if (response.ok && result.data) {
          // DB ë°ì´í„°ë¥¼ ì•± í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          state.savedData = result.data.map(item => ({
            id: item.id,
            name: item.name,
            birthDate: item.birth_date,
            birthTime: item.birth_time,
            gender: item.gender,
            mbti: item.mbti,
            saju: item.saju,
            daeun: item.daeun,
            western: item.western,
            eiPrediction: item.ei_prediction,
            answers: item.answers,
            savedAt: item.created_at
          }));
        }
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    function resetForm() {
      state.step = 1;
      state.formData = {
        name: '', year: '', month: '', day: '',
        timeKnownType: '', hour: '', minute: '0', roughTime: '',
        gender: 'female', mbti: '',
        pastMbtiType: '', pastMbti: '', pastMbtiPartial: ''
      };
      state.western = { sunSign: '', moonSign: '', ascSign: '' };
      state.saju = null;
      state.daeun = null;
      state.aiAnalysis = null;
      state.answers = {};
      render();
      window.scrollTo(0,0);
    }

    function exportData() {
      const dataStr = JSON.stringify(state.savedData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `saju_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    // ì´ˆê¸° ì‹¤í–‰
    async function init() {
      await loadSavedData();
      render();
    }
    init();
  </script>
</body>
</html>
